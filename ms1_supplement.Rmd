---
title: "Supplement X. Bottom-up drivers of the LRR effects"
author: "Piotr Szefer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, results='hide', fig.align = 'center')
```

```{r, echo = FALSE, warning=FALSE, message=FALSE, results='hide'}
source('code/log_ratio_extraction.R')
source('code/lrr_and_community_chars_correlations.R')
source('code/elevation_descriptors.R')
source("code/pgls_data_prep.R")
```


## Elevational patterns

The aim of our study was to evaluate the extent to which pathogenic fungi, insect herbivores, and their predators shape the biomass, richness, diversity, and community composition of pioneer stages in tropical forest regeneration along a natural elevation gradient.

The biomass of the control plots did not change significantly with elevation. However, richness, diversity, and density peaked at the mid-elevation. Surprisingly, the low elevation had the lowest number of pioneer woody plant species.

```{r}

ggpubr::ggarrange(bio.plot, rich.plot, div.plot, dens.plot)

```
<p style="font-family: times, serif; font-size:11pt; font-style:italic">
"Figure 1. Characteristics of three studied sites: biomass, richness, diversity (Simpson's index) and density of woody plants at the control sites."
</p>

Now, let's examine the effects that biotic factors had on the characteristics of vegetation.

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE, fig.width= 8, fig.height=8}

source('code/cx_lrr_panel.R')
lrr_panel

```
<p style="font-family: times, serif; font-size:11pt; font-style:italic">
    Figure 2. Magnitude and direction of fungi, insects and their predators on biomass, richness, diversity and density of woody plants along elevation gradient: Wanang (200 m a.s.l.); Numba (750 m a.s.l.); Yawan (1900 m a.s.l.). Log response ratio is a log-ratio of a given descriptor value from plots where a biotic factor was present to where it was absent. Grey points represent empirical values. Letters indicate statistically significant ($\alpha$ = 0.05) differences for pairwise comparisons between elevations within a treatment-descriptor combination with Tukey correction for multiplicity. For better readability letters are given only in cases where any of the mean were either different form each other or different from zero. Zero effect are indicated with a dashed line. Stars in the upper index indicate significant ($\alpha$ = 0.05) differences of the effect mean from zero (significance of the effect at a given site)
</p>

There are a few interesting patterns emerging from this comparison. First is the similarity in the impacts of insects and their predators on vegetation. If insects are controlled by their higher-level predators, we would expect to observe negative effects of insects and positive effects of predators on vegetation. However, empirical patterns indicate that the plant community's response to top predators exclusion resembled that of insecticide treatment. Because of the substantial influx of insects into the experimental plots, we were unable to completely eliminate insects from the area. Rather, we induced repeated insect population reductions. It's plausible that the recurrent eradication of the insect community may have disrupted the natural processes of interaction between predators and insects, which likely play a crucial role in shaping the ecosystem's reaction to the insecticide treatment.

Secondly, patterns in richness, diversity, and density appear to be linked to patterns in the effects of treatments. For instance, the impact of fungi on richness and density of woody plants appear to be inversely related to the elevation-based patterns in diversity. We specifically observe the following relationship: high richness is associated with a weak effect, while low richness is linked to a strong effect.

This observation could imply a pronounced bottom-up control on the strength of these effects. While the effects are indeed present, their magnitude appears to be influenced by the specific characteristics of the local community. Notably, at the mid-elevation with high plant diversity, the impact of biotic factors are weak, except for the significant effect of insects on biomass, not observed at low and high elevations. The highest elevation, with average species richness, also exhibits the most potent and consistently significant effects of biotic factors. This suggests a possible non-linear relationship between plant species richness and the strength of biotic factors.

## The effects of site richness and productivity of the LRR of biomass and diversity.

To explore the potential bottom-up forcing of effect sizes, I constructed nonlinear models. These models aimed to explain the log response ratios for biomass, richness, diversity, and density solely based on the potential productivity (biomass) and species influx (richness) of the garden. Those basal characteristics can be sourced from either the control plot or all treatment plots within a garden. In the former case, we derive a 'natural' species richness and productivity, which results from the interaction of all biotic factors in a naturally restricted area equivalent to the plot size. Alternatively, considering the entire garden provides a larger sample of potential species richness and potential productivity. In the following analysis I took the second approach. I calculated models individually for each site and compared them using the adjusted $R^2$ value to assess the predictive capability of total richness and average biomass at the garden level. I incorporated linear and quadratic terms without performing any model selection. The adjusted $R^2$ value can be interpreted as a measure of the extent of bottom-up and top-down control: negative values suggest that enhancing diversity and richness deteriorates the model - a strong indicator of top-down effects. Conversely, significantly positive values indicate bottom-up control: effectively predicting changes in descriptors based on the underlying community characteristics.

```{r}
#Treatment panels
ggplot(r2data %>%
         mutate(fDescriptors = factor(Descriptors,
                                       labels = c("Biomass LRR",
                                                  "Diversity LRR",
                                                  "Richness LRR",
                                                  "Density LRR"),
                                       levels = c("BioLRR",
                                                  "DivLRR",
                                                  "RichLRR",
                                                  "DenLRR"))), 
       aes(x = Site, y = AdjR2, fill= Treatement)) +
  geom_bar(stat = 'identity') + 
  # coord_flip() + 
  facet_grid(vars(fDescriptors), vars(Treatement)) + theme_bw() + 
  geom_hline(yintercept =  0,
             lty=2)

# Site panels
# ggplot(r2data %>%
#          mutate(fDescriptors = factor(Descriptors,
#                                        labels = c("Biomass LRR",
#                                                   "Diversity LRR",
#                                                   "Richness LRR",
#                                                   "Density LRR"),
#                                        levels = c("BioLRR",
#                                                   "DivLRR",
#                                                   "RichLRR",
#                                                   "DenLRR"))), 
#        aes(x = Treatement, y = AdjR2, fill= Site)) +
#   geom_bar(stat = 'identity') + 
#   # coord_flip() + 
#   facet_grid(vars(fDescriptors), vars(Site)) + theme_bw() + 
#   geom_hline(yintercept =  0,
#              lty=2)

```
<p style="font-family: times, serif; font-size:11pt; font-style:italic">
    Figure 3. Adjusted $R^2$ values of quadratic model of log response ratios (LRR) of pioneer plant biomass, diversity, richness and density to selected biotic factors: f- fungi; i - insects; p - predators. Natural logarithm of biomass and richness were used as only predictors of the LRR's. Quadratic terms were also introduced to allow for nonlinear responses.
</p>

The adjusted $R^2$ demonstrates significant variation across different treatments, sites, and descriptors. In terms of diversity, the impact of fungi shifts from top-down influence at low elevations to bottom-up effects at higher elevations. Notably, the effect of fungi on biomass is most pronounced at higher elevations. The influence on richness exhibits strong indications of top-down control at both low and high elevations. Conversely, at mid elevations, fungi display a weak effect on richness.

Interestingly, we discover limited top-down effects of insects, except for density at mid elevations and richness at high elevations. The influence of insects on richness exhibits an elevation-dependent increase. Notably, the adjusted $R^2$ values for the effect on biomass, richness, and density in Wanang are surprisingly high (bottom-up effect). However, it's crucial to exercise caution when interpreting parameter estimates due to the small sample size of 6 gardens in Wanang and only 5 parameters for estimation. Nevertheless, it's remarkable that a quadratic plane fits exceptionally well to these six data points. Concerning diversity, a noticeable compensation effect between herbivores and fungi is evident at low elevations, which undergoes a shift at higher elevations. Predators demonstrate more pronounced effects at greater elevations, except for plant biomass, which remains low at mid and high elevations.

To explain the Log Response Ratio (LRR) of biomass, diversity, richness, and density in relation to potential richness and productivity, I developed an extensive model that incorporated all relevant interactions. This model incorporated both linear and quadratic terms for both richness and productivity and interaction of these terms with site and treatment. Within each garden, I utilized the total richness and average biomass values at the garden level as predictors of the effect. Following this, the comprehensive models underwent a step-wise backward selection procedure, guided by the AIC criterion, to derive the final models (as presented in Table 1).

<p style="font-family: times, serif; font-size:11pt; font-style:italic">
Table 1: Models depicting the relationships between richness, biomass, and their interactions with Log Response Ratio (LRR) for the investigated treatments across distinct sites. The inclusion of quadratic terms was permitted, with variations in slopes and intercepts accounted for across sites and treatments, as well as between treatments within each site. The presented models are the outcomes of a backward selection procedure driven by the AIC criterion.
</p>
```{r, results='asis'}
tab_model(final.biolrr.nl.mod, final.riclrr.nl.mod,final.divlrr.nl.mod, final.denlrr.nl.mod)
```

The outcomes allow us to account for a substantial portion of the variance in treatment effects on biomass change (adjusted $R^2 = 0.367$). Conversely, the lowest proportion of variance can be elucidated for diversity change (adjusted $R^2 = 0.296$). This discrepancy suggests considerable impacts of biotic factors on richness, whereas effects on biomass, density, and diversity are more confined. It appears that local conditions play a determining role in biomass, while biotic factors predominantly influence the assembly process.

```{r pressure, echo=FALSE, fig.width=10, fig.height=15}
ggpubr::ggarrange(BioPredPlot, RicPredPlot, DivPredPlot, DenPredPlot,
                  BioPredPlotR, RicPredPlotR, DivPredPlotR, DenPredPlotR,
                  nrow = 4, ncol = 2,
                  labels = c("A", "B", "C", "D",
                             "E", "F", "G", "H"),
                   common.legend = TRUE, legend="bottom")
```
<p style="font-family: times, serif; font-size:11pt; font-style:italic">
    Figure 4. Predictions of the models for LRR form the Table 1.
</p>

All plant community characteristics are interconnected. For instance, biomass is associated not only with richness but also with species composition. It tends to increase with the complexity of a plant community (Cardinale et al. 2007). 

There are two non-mutually exclusive ways in which biotic factors affect plant communities: they either serve as filters for species or alter competitive outcomes among species. However, in our experiment, distinguishing between these two processes' final outcomes might be challenging without tracking species influx and mortality with a reasonable temporal resolution.

Just to stay cnsostent I compared the most complex models with the simplest models to have an idea how good of predictors site and treatments are.

```{r, results='asis'}
knitr::kable(biolrr.comp, caption =  "Response: Biomass effects")
knitr::kable(riclrr.comp, caption =  "Response: Richness effects")
knitr::kable(divlrr.comp, caption =  "Response: Diversity effects")
knitr::kable(denlrr.comp, caption =  "Response: Density effect")

```

# Treatment responses on individual species

The previous analyses clearly indicate that the studied biotic factors exert a limited influence on plant biomass at the community level. However, they manifest diverse impacts on species richness and diversity. Our primary objective is to identify potential differences between treatment plots and controls concerning community composition.

We collected traits linked to growth rate and resource acquisition, encompassing specific leaf area (SLA), water content, biomass, and herbivore damage. In this section, our focus is on plant species identity and traits, assessing their utility in predicting individual species performance within specific plots. I explore the primary predictor of treatment response: whether it is species identity, necessitating individual species-level analysis (which might be impractical), or species traits, which allows for elevation-based comparisons. This inquiry is pursued through a range of methodologies, including:

Redundancy Analysis (RDA) to discern species exhibiting directional responses to treatments.

Correlation of RDA axes with plant species traits. Rather than considering plant IDs, we examine their traits to identify whether certain traits are correlated with the treatment effect vectors—vectors of change identified in the RDA.

Employing Random Forest to establish the significance of traits in predicting categorical plant responses to treatments.

Through this, I aim to predict whether a species, based on its traits, will be lost, gained, or retained across various treatment plots. To achieve this, we utilize the Random Forest algorithm to explore the importance of traits in predicting species outcomes. We assess prediction accuracy using the "classifier_RF" approach. This analysis provides insights into the effectiveness of the trait set (including the most influential traits) in predicting outcomes for individual species.

Analyzing Community Weighted Means (CWMs) for trait responses across the entire community.

Applying Phylogenetic Generalized Least Squares (PGLS) models to evaluate changes in plant species biomass based on their trait values in response to treatments.

### 1. RDA

```{r, fig.height=10, fig.width=10}
source('code/cx_rda_analysis.R')
## 3.2 Plot the ordination ----
ggpubr::ggarrange(plot.list[["w"]]$sites.ord,
                  plot.list[["w"]]$species.ord,
                  plot.list[["n"]]$sites.ord,
                  plot.list[["n"]]$species.ord,
                  plot.list[["y"]]$sites.ord,
                  plot.list[["y"]]$species.ord, ncol = 2, nrow = 3,
                  labels = c("Wanang","", "Numba","","Yawan",""))
```
<p style="font-family: times, serif; font-size:11pt; font-style:italic">
    Figure 5. RDA plots with red arrows indicating statistical significance of treatments.
</p>

Plant communities subjected to insecticide treatments differ from the control plots across all elevations. On the other hand, communities treated with fungicide exhibit variations from the control plots solely at higher elevation. Several species show discernible responses to these treatments as observed in the diagrams:
* *Pipturus argenteus* experiences an increase in abundance within insecticide-treated plots in Wanang and Yawan.
* *Trema orientale* exhibits this trend in Numba.
* *Piper recessum* and *Macaranga strigosa* demonstrate a response to fungicide treatment specifically in Yawan.

<p style="font-family: times, serif; font-size:11pt; font-style:italic">
Table 2. Results of the Monte Carlo permutation to evaluate significance of each treatment on the plant community composition. RDA analyses are conditioned on the garden variable.
</p>
```{r, results='asis'}
options(knitr.kable.NA = '')
knitr::kable(anova(ord.list[["w"]], by="terms"), caption = "Wanang")
knitr::kable(anova(ord.list[["n"]], by="terms"), caption = "Numba")
knitr::kable(anova(ord.list[["y"]], by="terms"), caption = "Yawan")
```

As we tried to show in the previous sections t's possible that certain alterations in plant community composition could be attributed to initial variations in richness rather than the influence of a specific factor. Biotic factors could affect richness that has effect on plant species dynamics and result in changes in species composition.

When we introduce the conditional impact of richness and biomass instead of garden identity, we observe the loss of significance in treatment effects. This observation could imply that insects, predators, and fungi exert a more pronounced influence on the assembly process compared to inter-specific plant interactions.

<p style="font-family: times, serif; font-size:11pt; font-style:italic">
Table 3. Results of the Monte Carlo permutation to evaluate significance of each treatment on the plant community composition. RDA analyses are conditioned on the garden species richness and average plot biomass.
</p>
```{r, results='asis'}
options(knitr.kable.NA = '')
knitr::kable(anova(result.list[["w"]], by="terms"), caption = "Wanang")
knitr::kable(anova(result.list[["n"]], by="terms"), caption = "Numba")
knitr::kable(anova(result.list[["y"]], by="terms"), caption = "Yawan")
```

### 2. Can traits predict change in composition?

For each treatment I correlated the position of each species along an 'effect gradient' - a vector that point to same direction as a treatment, and correlated it with individual species tratits. SLA doesn’t predict RDA position along C->I, C->H, C->P, C -> F axes, at any elevation. Community composition change under a treatment may be independent of SLA - the key indicator of functionally important aspects of photosynthetic capacity, and is positively correlated with ecosystem productivity (White et al., 2000, Madani et al., 2017, Anderson et al., 2020). SLA reflects the abilities of light capture and adaption to environments of plants (Gao, Wang, and Zhang 2022)]. The regression analyses are corrected for phylogeny using the phylogenetic covariance matrix.

```{r, results='asis'}

source('code/cx_trait_ord.R')

m1 <- traitPredsCommComp(treatment = "f",
                             ordination = result.list,
                             st = "wanang")
m2 <- traitPredsCommComp(treatment = "f",
                             ordination = result.list,
                             st = "numba")
m3 <- traitPredsCommComp(treatment = "f",
                             ordination = result.list,
                             st = "yawan")
m4 <- traitPredsCommComp(treatment = "i",
                             ordination = result.list,
                             st = "wanang")
m5 <- traitPredsCommComp(treatment = "i",
                             ordination = result.list,
                             st = "numba")
m6 <- traitPredsCommComp(treatment = "i",
                             ordination = result.list,
                             st = "yawan")



tab_model(m1$model,
          m2$model,
          m3$model,
          dv.labels = c(m1$title,
                        m2$title,
                        m3$title))


tab_model(m4$model,
          m5$model,
          m6$model,
          dv.labels = c(m4$title,
                        m5$title,
                        m6$title))


```

In Numba, both Specific Leaf Area (SLA) and water content are significant predictors of a species' position along the vector of treatment effects. However, in Yawan, only water content holds significance in this regard. Otherwise, traits demonstrate limited predictive power for the ordination process. RDA tries to find a general trends, which may be difficult to evaluate because of the high variation in species composition between replications (individual experimental gardens) within a site.

```{r}
source('code/multi_site_beta.R')

ggplot(vardf_full, aes(y = JaccardVar, x = Treatment, fill = Treatment))+
  geom_col()+facet_grid(~Site)+theme_bw()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```
<p style="font-family: times, serif; font-size:11pt; font-style:italic">
Figure 6. Variance in species composition (Jaccard distance) for all pairwise comparisons between control sites at each elevation and treatment.
</p>

The variation observed among the different sites is influenced, to some extent, by the relative species richness present at each elevation. The average Bray-Curtis within treatment, within site dissimilarity holds a consistently high value of around 95%. Notably, in Wanang and Yawan, all treatments led to a reduction in variance. However, a distinct pattern emerges in Numba, where the variance under the predator treatment surpassed that of the control treatment.

Given the potential influence of insects on the assembly process and subsequent alterations in community composition, we will later delve into the components of B-C dissimilarity and explore the assembly process itself using null models.

### 3. Random forest

First we look whether some of the traits can help us understand wether some plants will be:
* missing at the treatment plot but present at the control plot (lost);
* present at the treatment plot but missing from the control plot (gained)
* present in both treatment and control plot (stayed). 

```{r}
source('code/cx_random_forest.R')
```

```{r, figures-side, fig.show="hold", out.width="50%"}
vipP <- varImpPlot(prfres$classifier_for_varImpPlot,
           main = 'Variable Importance for the predator exclusion')
# barplot(height = c(vipP), names.arg = rownames(vipP))
varImpPlot(irfres$classifier_for_varImpPlot,
           main = 'Variable Importance for the insect exclusion')
varImpPlot(frfres$classifier_for_varImpPlot,
           main = 'Variable Importance for the fungi exclusion')
varImpPlot(hrfres$classifier_for_varImpPlot,
           main = 'Variable Importance for the herbivore addition')

# MDSplot(prfres$classifier_for_varImpPlot, prfres$train_data$pg.cat, 
#         main = "Predator")
# MDSplot(irfres$classifier_for_varImpPlot, irfres$train_data$pg.cat,
#         main = "Insecticide")
# MDSplot(frfres$classifier_for_varImpPlot, frfres$train_data$pg.cat,
#         main = "Fungicide")
# MDSplot(hrfres$classifier_for_varImpPlot, hrfres$train_data$pg.cat,
#         main = "Herbivory")
```

```{r}

pcm <- prfres$rf_confusion_matrix
icm <- irfres$rf_confusion_matrix
fcm <- frfres$rf_confusion_matrix
hcm <- hrfres$rf_confusion_matrix

pacc <- sum(diag(pcm))/sum(pcm)
iacc <- sum(diag(icm))/sum(icm)
facc <- sum(diag(fcm))/sum(fcm)
hacc <- sum(diag(hcm))/sum(hcm)

```

With the variables we have collected, accurately predicting the fate of individual species remains challenging. The prediction accuracies are as follows: `r iacc` for the insecticide treatment; `r facc` for the fungicide treatment; `r pacc` for the predator treatment; and `r hacc` for the herbivore addition treatment. Notably, for all predictions, total biomass emerges as the most significant predictor of a species' fate. Conversely, SLA and the number of stems are the least influential predictors. To illustrate this division, we employ a single regression tree.

### 4. Whole community trait response (CWMs)

The preceding analysis focused on the individual level, aiming to anticipate whether we can predict a species' fate based on its traits. This had a moderately satisfactory level of predictive ability, with minimal discrepancies in prediction accuracy across the various treatments.

Alternatively, I explore whether any of the treatments impacted the community-weighted mean for traits. This approach delves into understanding how traits at the community level were affected by the treatments.

```{r, fig.cap='Community weighted mean vs number of species at a site for the studied treatments at three elevations. Size of a point indicates total plant biomass of that plot.'}

source('code/cx_cwm.R')
ggpubr::ggarrange(p1,p1.wc)


```

The Community Weighted Mean of Specific Leaf Area (CWM SLA) exhibited higher values in plots with lower diversity. This implies that species with relatively higher SLA were the dominant contributors to these communities. This pattern is also evident for water content and remains consistent regardless of the treatment or site. This trend appears to be quite widespread, suggesting that biotic factors might exert a limited impact on the trait composition itself. Instead, their influence seems to primarily affect species richness, which subsequently affects other aspects of the plant community's characteristics.

```{r, results='asis'}
# Test for the relationship and the differences
require(sjPlot)
cwm.lm <- lm(log(cwm.sla)~log(sp.rich)*treatment + site, data = siteSLAdf)
cwm.lm.nosite <- lm(log(cwm.sla)~log(sp.rich)*treatment, data = siteSLAdf)
cwm.lm.nosite.noint <- lm(log(cwm.sla)~log(sp.rich)+treatment, data = siteSLAdf)
cwm.lm.onlysp <- lm(log(cwm.sla)~log(sp.rich), data = siteSLAdf)


# cwm.glm <- glm(cwm.sla~sp.rich*treatment + site, data = siteSLAdf,
#              family = gaussian(link = 'log'))
# cwm.glm.nosite <- glm(cwm.sla~sp.rich*treatment, data = siteSLAdf,
#                     family = gaussian(link = 'log'))
# cwm.glm.nosite.noint <- glm(cwm.sla~sp.rich+treatment, data = siteSLAdf, 
#                           family = gaussian(link = 'log'))
# cwm.glm.onlysp <- glm(cwm.sla~sp.rich, data = siteSLAdf, family = gaussian(link = 'log'))

# tab_model(cwm.lm.nosite.noint)


# anova(cwm.lm.nosite, cwm.lm.onlysp)
knitr::kable(AIC(cwm.lm, cwm.lm.nosite, cwm.lm.nosite.noint, cwm.lm.onlysp))
# knitr::kable(AIC(cwm.glm, cwm.glm.nosite, cwm.glm.nosite.noint, cwm.glm.onlysp,
                 # cwm.lm, cwm.lm.nosite, cwm.lm.nosite.noint, cwm.lm.onlysp))

# tab_model(cwm.glm)
tab_model(cwm.lm.onlysp)

# plot(cwm.glm)
# plot(cwm.lm)

# there are no differences 

```

### 5. Individual species performance baed on taits

In control plots with increasing elevation, we hypothesized that Specific Leaf Area (SLA), serving as a proxy for growth rate, will progressively become a stronger predictor of various aspects of species' success. This includes factors such as fitness, dominance, and changes in biomass in response to treatments. More specifically, we expect that plants with higher SLA will demonstrate an enhanced capability to dominate the community, as reflected by higher total biomass in scenarios where natural enemies have been removed. In these situations, we assume that interspecific plant competition will be primarily influenced by differences in growth rates.

For a more comprehensive measurement of a species' response to a treatment, change in biomass (delta biomass) might be a superior metric. This measurement excludes species that were either lost or gained in response to treatments. However, the prior analysis has indicated that these plants tend to be relatively small, often in poor condition or newly established in a plot. Several challenges complicate the interpretation of this relationship. To mitigate these issues, incorporating covariates into the model of biomass change can offer some improvement.

1. **Richness**: The Specific Leaf Area (SLA) of a species might be influenced by the characteristics of the community it inhabits, as indicated by both Community Weighted Mean (CWM) traits and their dependency on species richness. However, at the individual level, we do not observe any alteration in the SLA of individual species in response to the richness of the plot. This implies that the increased CWM SLA in low richness plots is driven by the dominance of high SLA plants rather than changes in the SLA of the dominants. This aligns with the absence of discernible differences in community composition, that would be captured if changes in species composition were more based on changes in dominance structure.

It's worth noting that the lack of significant treatment effects in the RDA analysis could potentially be attributed to substantial variation between gardens, especially evident in the control sites with high variability. To address this, incorporating the identity of an experimental plot as a co-variate in the model could be beneficial.

```{r}

# SLA of selected species at different treatments.

# Sla of selected species vs species richness

```

2. **Change in SLA**: From our data, it is apparent that certain treatments can lead to variations in the average Specific Leaf Area (SLA) of the same species. This change in SLA has the potential to impact the alteration in biomass, or conversely, changes in biomass might influence SLA. Importantly, this dynamic relationship extends to the two other traits as well. Therefore, it's crucial to consider all relevant traits when assessing these interactions.

```{r}

# Change in SLA vs change in Biomass

```

3. **Abundance**: Biomass/$\Delta$Biomass ratios might be reduced when there is a higher density of individuals from the same species in the vicinity. Consequently, I believe it's important to incorporate the influence of co-specifics’ abundance in our analysis.

4. **Total biomass**: Furthermore, the productivity of a site (total biomass) could also impact the change in biomass; for instance, the change in biomass might be less pronounced for smaller plants and more significant for larger plants. Regarding the interpretation of these measures.

Delta BIO quantifies how dominance within the community has changed due to the treatment. If there was a plant that was dominant in the control condition and its biomass experienced a substantial reduction in response to the treatment, this would signify that the treatment had a notable effect on diminishing the dominance of that specific plant in the community. In essence, it indicates a shift in the plant's importance or influence within the community due to the treatment's impact on its biomass.

Taking the aforementioned considerations into consideration, we have formulated the final statistical model. In this model, the response variable is $\Delta$Biomass. We assess its dependence on SLA while incorporating the corresponding site richness and abundance of co-specifics as covariates. To examine the influence of treatments on the relationship between $\Delta$Biomass and SLA, we introduce the interaction between SLA and the treatment variable. This model is replicated for each site, and we evaluate its performance to compare the predictive power of SLA for biomass changes across elevations. In order to maintain phylogenetic correlations, we include a quadratic term.

Furthermore, I explore nonlinear relationships between biomass log-ratios and species traits. The inclusion of these nonlinear relationships allows for the consideration of optimal trait values. All these insights lead us to define the comprehensive structure of the final model.

$\Delta$Biomass ~ SLA $\times$ site + SLA^2 $\times$ site + 
water.content $\times$ site + water.content^2 $\times$ site + 
perc.herb $\times$ site  + perc.herb^2 $\times$ site + 
richness + abundance + $\Delta$SLA + 
(Phylogenetic structure). 

This model needs to be fit independently for each treatment to calculate the respective changes in SLA and biomass.

There is some evidence pointing towards changes in total biomass being influenced by SLA. Both water content and log-response ratios of SLA significantly impact changes in total biomass. However, it's important to note that these changes could potentially be driven by a strong correlation in a single site, Wanang. Specifically, higher water content leads to positive changes in species biomass, while a substantial increase in SLA of a species correlates with a reduction in that species' biomass. Notably, none of the interactions with site were found to be significant.

In terms of random effects, they might not be necessary given the paired comparisons of control vs. treatment within the same garden. Another option would be to incorporate the site as a random factor, which could lead to the elimination of all interaction terms.

It is important to acknowledge that if we analyze the data separately for each elevation, the results might differ, especially if we solely rely on the variable lsla.d. More comprehensive models, such as those encompassing the effects of species richness and other traits, as discussed earlier, could potentially alter this relationship.

```{r, results='asis'}

source('code/cx_sla_pgls.R')

# Plot
ggpubr::ggarrange(pslap +
                    scale_y_continuous(limits = c(-5, 10)),
                  fwaterp + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  hwaterp + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  nrow = 1, legend = F)
ggpubr::ggarrange(psitep + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  fsitep + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  hsitep + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  nrow = 1,legend = F)
ggpubr::ggarrange(prichp + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  frichp + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  nrow = 1, legend = F)
ggpubr::ggarrange(plabup + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  ilabup + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  hlabup + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  nrow = 1, legend = F)
ggpubr::ggarrange(plrrslap +
                    scale_y_continuous(limits = c(-5, 10)), 
                  hlrrslap + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  nrow = 1, common.legend = T)

```

```{r, results = 'asis'}

tab_model(p.mod, i.mod, h.mod, f.mod,
          pred.labels = c("Intercept", 
                          "Log[SLA]-linear", 
                          "Numba", 
                          "Yawan",
                          "Log[SLA]-quadratic", 
                          "Water content - linear", 
                          "Water content - quadratic",
                          "Herbivory [%] - linear",
                          "Herbivory [%] - quadratic",
                          "Species richness",
                          "Abundance",
                          "LRR SLA",
                          "Log[SLA]-linear : Numba",
                          "Log[SLA]-linear : Yawan",
                          "Log[SLA]-quadratic : Numba",
                          "Log[SLA]-quadratic : Yawan",
                          "Water content-linear : Numba",
                          "Water content-linear : Yawan",
                          "Water content-quadratic : Numba",
                          "Water content-quadratic : Yawan",
                          "Herbivory-linear : Numba",
                          "Herbivory-linear : Yawan",
                          "Herbivory-quadratic : Numba",
                          "Herbivory-quadratic : Yawan"),
          dv.labels = c("Predator", "Insecticide", "Extra herbivory", "Fungicide"),
          string.pred = "Coeffcient",
          string.ci = "Conf. Int (95%)",
          string.p = "P-Value")

```


## Effect of biotic factors on the community assembly.

We employed beta-diversity partitioning techniques to assess the predominant influences on processes, namely species competition and species turnover. Subsequently, we delve into the enhancement of predictability for the successional process by evaluating the impact of biotic factors using the Raup-Crick index.

### 1. B-C


In this section, I will explore whether any of the studied treatments have the capacity to mitigate this dissimilarity. Moreover, I will dissect this dissimilarity into its two constituent components of beta diversity, known as the gradient and balanced components (as referenced). The balanced component provides insight into the extent of dissimilarity attributed to species turnover, while the gradient component pertains to shifts in abundance gradients. This latter aspect is connected to alterations in diversity, such as changes in the dominance structure.

```{r}
source('code/cx_beta_part.R')
```

```{r, fig.width=8, fig.height=6}
beta.part.plot2
```
<p style="font-family: times, serif; font-size:11pt; font-style:italic">
Figure 7. All pairwise dissimilarities (Bray-Curtis) in species composition between given treatment plots at each elevation. Dissimilarities are broken down into two components: responsible for the species turnover (balanced component), and for changes in species dominance structures (gradient components). Starst indicate that a given average was significantly different from that at the control plot ($\alpha < 0.05$). To compare the averages the beta regression was used as the values for B-c are always between 0 and 1.
</p>

The figure illustrates distinct impacts on various processes attributed to different treatments. In Wanang, high dissimilarity is mitigated by insects, leading to a transition from significant species turnover towards more substantial shifts in species composition. Conversely, in Numba, no apparent alterations in dissimilarity were observed. However, the introduction of additional herbivores, predators, and particularly insects led to a noteworthy increase in species turnover while simultaneously causing changes in dominance structure. These same treatments in Yawan led to a decrease in species turnover, contributing to a general reduction in species dissimilarity. However, these reductions were not equally balanced by significant changes in dominance structure.

The comprehensive analysis implies that biotic factors can yield varying effects at different elevations. These effects may be correlated with the initial species richness and the community composition's variance. At mid elevations, the presence of insects reduces species turnover and promotes shifts in dominance. In Yawan, where biomass accumulation is slower, insects increase turnover, subsequently resulting in heightened dissimilarity between plant communities. Alterations in species turnover can have dual consequences: if it increases, it could drive divergence in compositions between sites; conversely, reduced species turnover might also magnify differences by chance, due to the inherently smaller pool of species being distinct from site to site, thus amplifying dissimilarities.

To further investigate this matter, we conducted a simulation analysis employing the Raup-Crick index, which gauges the predictability of the assembly process.

### 2. Raup-Crick

```{r}
source('code/cx_rcplot.R')

rcplot

```
<p style="font-family: times, serif; font-size:11pt; font-style:italic">
Figure X. Differences in Raup-Crick values between the control plot and treatment plots at each elevation.
</p>

In Wanang and even more notably in Yawan, we observe a deterministic divergence in community composition within the control plots. In Wanang, only the additional herbivores and predator treatments managed to shift this process towards a more random pattern. In Yawan, all treatments achieved this outcome. In Numba, on the other hand, the baseline community displayed a relatively random pattern, and only the addition of herbivores managed to nudge it towards deterministic divergence, potentially by reducing the richness of the plant community.

With this understanding, we now recognize that biotic factors exert a significant influence on community composition. These alterations are contingent upon the baseline community richness and the productivity of the site. Biotic factors impact the assembly process by modifying the richness of pioneer communities at both the highest and lowest elevations, albeit to a lesser extent in the latter. At the mid elevation, the considerable variation in community composition appears to attenuate the effects of biotic factors.

Our findings highlight that biotic factors indeed can significantly affect richness, and these effects subsequently trigger shifts in community composition. We are now interested in understanding whether specific traits undergo filtration or perform better under these conditions. Furthermore, we aim to investigate which traits emerge after filtration and how they are subsequently suppressed.

## Discussion

The unexpected outcome reveals that all treatments yield comparable effects, with Numba displaying some distinct patterns in these effects. In Wanang, where species richness is the lowest, insects led to an increase in richness, while fungi prompted enhancements in both richness and the density of pioneer woody plants. These situations are nearly identical in nature.

Surprisingly, the anticipated differentiation in effects between predator and insecticide treatments was not achieved. This could potentially be linked to additional mechanisms operating within the exclosure setups. Strikingly, all treatments—herbivore addition, insecticide treatment, and predator exclosure—exerted analogous effects on plant community composition.

