---
title: "Supplement X. Bottom-up drivers of the LRR effects"
author: "Piotr Szefer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, results='hide', fig.align = 'center')
```

```{r, echo = FALSE, warning=FALSE, message=FALSE, results='hide'}
source('code/lrr_and_community_chars_correlations.R')
source('code/elevation_descriptors.R')
source('code/log_ratio_extraction.R')
```


## Introduction

Aim of our study was to evaluate to what extent pathogenic fungi, insect herbivores, and their predators shape community composition of pioneer stages of tropical forest regeneration. Further we were interested in the effect of natural elevation gradient on the direction and strength of these effects.

Looking at biomass, diversity (number of species and Simpson's index values), and density of woody plant species. Biomass did not change much with elevation, but diversity and density peaked at the mid elevation.

```{r, fig.cap="Figure 1. Characteristics of three studied sites: biomass, richness, diversity (Simpson's index) and density of woody plants at the control sites."}

ggpubr::ggarrange(bio.plot, rich.plot, div.plot, dens.plot)

```

Now lets look at the effects that the biotic factors had on the vegetation characteristics.

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE, fig.cap= "Figure 2. Magnitude and direction of fungi, insects and their predators on biomass, richness, diversity and density of woody plants along elevation gradient: Wanang (200 m a.s.l.); Numba (750 m a.s.l.); Yawan (1900 m a.s.l.). Log response ratio is a log-ratio of a given descriptor value from plots where a biotic factor was present to where it was absent. Grey points represent empirical values. Letters indicate statistically significant ($\\alpha$ = 0.05) differences for pairwise comparisons between elevations within a treatment-descriptor combination with Tukey correction for multiplicity. For better readability letters are given only in cases where any of the mean were either different form each other or different from zero. Zero effect are indicated with a dashed line. Stars in the upper index indicate significant ($\\alpha$ = 0.05) differences of the effect mean from zero (significance of the effect at a given site)", fig.width= 8, fig.height=8}

# bio, dens, div, rich
panel_data <- data.frame()

dats <- list(biomass = BIOMASS.LR, 
             denssity = DENSITY.LR, 
             diversity = DIVERSITY.LR, 
             richness = RICHNESS.LR)

# Stack the data and rename descriptor names
for (file in names(dats)){
  # print(file)
  dat <- dats[[file]]
  dat$descriptor <- ifelse(grepl("bio", file), "Biomass",
                           ifelse(grepl("dens", file), "Woody plant density",
                                  ifelse(grepl("div", file),"Diversity", "Richness")))
  dat <- dat[, c("site", "garden", "treatment", "lratio","descriptor")]
  panel_data <- rbind(dat, panel_data)
}

# Make a renamed factor variable for the treatments

panel_data$ftreatment <- panel_data$treatment

# Fix treatment names
panel_data$ftreatment[panel_data$ftreatment == "i"] <- "Insects"
panel_data$ftreatment[panel_data$ftreatment == "p"] <- "Birds, bats and ants"
panel_data$ftreatment[panel_data$ftreatment == "f"] <- "Fungi"
panel_data$ftreatment[panel_data$ftreatment == "h"] <- "Increased herbivory"
panel_data$ftreatment <- factor(panel_data$ftreatment,
                           levels = c("Fungi",
                                      "Insects",
                                      "Birds, bats and ants",
                                      "Increased herbivory"
                                      ))

# Set the transparency value
aph <- 0.5

# Create a factor variable for sites
panel_data$fsite <- factor(panel_data$site, labels = c("Low",
                                      "Mid",
                                      "High"))

# Display panel plot
ggplot(panel_data, aes(x = fsite, y = lratio))+
  geom_jitter(width = 0.1, alpha = 0.1, size = 2)+
  
  # Group means
  stat_summary(fun = mean, na.rm = T,
               geom = "point", size = 2,
               alpha = aph)+
  
  stat_summary(fun.data = "mean_cl_boot",
               alpha = aph) + 
  
  # Annotations
  geom_text(data = panel_data %>%
              group_by(ftreatment, fsite) %>%
              summarise(mlr = mean(lratio)),
            aes(x = fsite, y = mlr + 1.5, group = ftreatment,
                label = lrr_panel_labs),
            size = 3)+
  
  theme_bw()+
  theme(strip.text = element_text(size =5.5),
        axis.text.x = element_text(angle = 0,
                                   hjust = 0.5))+
  geom_hline(yintercept = 0, lty = 2)+
  ylab("Log response ratio")+xlab("")+
  facet_grid(descriptor ~ ftreatment)

```

If we look at the biomass plots and a the effect plots we might be struck by a close relationship between some of these patterns. For example, the effect of fungi on biomass is lacking and seems exactly as the biomass patterns at each elevation. Effects of fungi, insects and predators on diversity measures seem to be inversely proportional to the elevational patterns in diversity and density.

This may suggest a strong bottom-up control of the effect strength. The effect are present, but the local community characteristics may influence their magnitude. It seems that at the highly diverse mid elevation, the effects of biotic factor is limited. Only one outstanding effect is of insects on biomass. Highest elevation has average species richness. But this elevation seems also to have the strongest and most frequently significant effects of biotic factors. This suggests that the strength of biotic factors may be related non-linearly with plant species richness.

Surprising is also similarity in the effects of insects and their predators. If insects are being controlled by their top predators we should see a negative effects of insects and positive effects of predators. This pattern means that in the plots where the insecticide was sprayed the outcome for plant community was the same as in the enclosure, where top predators were not present. When we were constantly re-setting insects community we disturbed natural processes of interaction forming between predators and insects.

## The effects of site richness and productivity of the LRR of biomass and diversity.

I investigated how well the actual observed effects of biotic factors can be explained by species richness and biomass of the woody plant community at the site level. Within each garden i used richness and biomass of the control plot as a predictor of the effect. These relationships can differ for treatments and sites, and can also be non-linear, all of which was allowed while defining models. Full models were then subjected to step-wise backward selection based on the AIC criterion to produce final models (Tab 1.).

<p style="font-family: times, serif; font-size:11pt; font-style:italic">
    Table 1. Models of richness and biomass and their relationships with LRR of studied treatments at different sites. Quadratic terms were allowed and slope and intercepts were allowed to differ between the sites and treatments and also between treatments within each site. The model sare results of backward selection process based on tha AIC criterion.
</p>

```{r, results='asis'}
tab_model(final.biolrr.nl.mod, final.riclrr.nl.mod,final.divlrr.nl.mod, final.denlrr.nl.mod)
```

Based on the results we can explain much of the variance of the biomass effects of the treatments on biomass change (adjusted $R^2 = 0.615$). The least amount of variance can be explained for the diversity change (adjusted $R^2 = 0.296$). This agrees with the rather weak effects of biotic factors on biomass but more diverse and clear effects on diversity, richness and density. It is possible that the biomass is determined by the local conditions, but the assembly process is mostly affected by biotic factors.

```{r pressure, echo=FALSE, fig.width=10, fig.height=15}
ggpubr::ggarrange(BioPredPlot, RicPredPlot, DivPredPlot, DenPredPlot, 
                  BioPredPlotR, RicPredPlotR, DivPredPlotR, DenPredPlotR,
                  nrow = 4, ncol = 2,
                  labels = c("A", "B", "C", "D",
                             "E", "F", "G", "H"),
                   common.legend = TRUE, legend="bottom")
```
<p style="font-family: times, serif; font-size:11pt; font-style:italic">
    Figure 1. Predictions of the models for LRR form the Table 1.
</p>

Let us look at similar models, but for each individual site, to compare the $R^2$ values. We are interested in the adjusted $R2$ because we want to evaluate the predictive ability of the richness and biomass. Therefore, I excluded the treatment, used linear and quadratic terms and did not perform model selection. Whenever we see a large positive $R^2$ we can suspect strong bottom-up control. Low to negative adjusted $R^2$ values indicate top-down action

```{r}

# ggplot(r2data, aes(x = Site, y = AdjustedR2, fill = Site)) +
#   geom_bar(stat = 'identity') + 
#   coord_flip() +
#   facet_grid(~Descriptor) + 
#   theme_bw()

ggplot(r2data, aes(x = Site, y = AdjR2, fill = Treatement)) +
  geom_bar(stat = 'identity') + 
  # coord_flip() + 
  facet_grid(vars(Descriptors), vars(Treatement)) + theme_bw() + 
  geom_hline(yintercept = c(-0.75, -0.5, 0, 0.5, 0.75), 
             lty=2)

```

The adjusted $R^2$ varies a lot for different treatments, sites and descriptors. The value of the adjusted $R^2$ could be interpreted as a measure of the level of bottom-up and top-down control: negative values indicate that adding diversity and richness only makes the model worse - this is a strong indicator of top-down effects. In contrast, high positive values are indicative to bottom-up control: we can predict well changes in descriptors depending on the baseline community characteristics.

Fungi effects on diversity shifts from bottom-up at low to top-down at high elevation. Effect of fungi on biomass gets stronger with elevation. At the mid elevation insects have weak effect on richness, but stronger on diversity. 

Some of the strongest top-down effects of insects on richness and diversity were found in Wanang. Effect of insect on diversity decreases with elevation, but changes non-monotonously for richness density and biomass, showing peaks in bottom-up control at mid-elevation.

For diversity there is a clear compensation of herbivores for fungi at the low elevations, that shifts at the high elevation.

Predators have stronger effects at the higher elevations except for plant biomass, which is low at mid and high elevations.

All of the community characteristics are interrelated. For example biomass is related to richness and also to the identity of the species involved (ref), and increases with the complexity of a plant community (Cardinale et al 2007). We see some strong indications that insects determine richness and diversity at low elevations, density and biomass at high elevation, and at the mid elevation they only affect diversity in a significant way. Changes in richness and diversity can happen in two ways: biotic factors can either be filters for species, or they can change competitive outcomes at between species. Unfortunately the end results may be the same for these two processes. 

What we can investigate though is what actually was more important in responding to a given treatment. Was it species identity (which basically means that we need to look at each species individually - bad) or was it some trait values. Basically what we want to do here is to see whether response to a treatment is species specific or trait specific. We could only use species that are present in at least 3 gardens at all three elevations, or within each elevation do the analysis, which is more plausible. We will look whether certain species are being excluded, or whether species composition response can be better explained by changes in plant trait composition. We will perform RDA or CCA on species id's and on species traits instead.

These results suggest that:
* biomass is largely bottom up controlled, but the effects of biotic factors: insects, fungi and predators are increasingly more important at the higher elevations.
* community assembly processes seem to be more strongly affected by biotic factors.
* some of the strongest top-down effects on diversity and richness were found at the lowest elevation for insects, and highest elevation for fungi.
* there is a general weak bottom-up control at the highest elevation.

Lets us investigate the effect of individual treatments on the community assembly process.

## Effect of biotic factors on the community assembly.

First we want to know whether some treatments resulted in a statistically different communities. We build RDA models for each elevation. We evaluated which processes species competition or the species turnover were mostly affected, and we used Raup-Crick to evaluate which biotic factors can improve predictability of the successional process.

### RDA

```{r, fig.height=10, fig.width=10}
source('code/cx_rda_analysis.R')
## 3.2 Plot the ordination ----
ggpubr::ggarrange(plot.list[["w"]]$sites.ord,
                  plot.list[["w"]]$species.ord,
                  plot.list[["n"]]$sites.ord,
                  plot.list[["n"]]$species.ord,
                  plot.list[["y"]]$sites.ord,
                  plot.list[["y"]]$species.ord, ncol = 2, nrow = 3)
```

Plant communities treated with insecticide are different from the control plots at all elevations. Fungicide treated communities are differenet from the control only at the high elevation.

```{r, results='asis'}
options(knitr.kable.NA = '')
knitr::kable(anova(ord.list[["w"]], by="terms"))
knitr::kable(anova(ord.list[["n"]], by="terms"))
knitr::kable(anova(ord.list[["y"]], by="terms"))
```

### B-C


### Raup-Crick


## Are traits better predictors of the species success?