---
title: "Data Analysis"
author: "Piotr Szefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

```

## Experimental design


```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE}
# The source file loads the data preparation script, where the raw data is read and summarised for further analyses
source('code/log_ratio_extraction.R')

# Over-dispersion test for the density in the fungicide treatment
# lrdata <- DENSITY.LR
# lvT <- leveneTest(lratio ~ site, data = lrdata %>% filter(treatment == "f"))
# lvtpval <- lvT$`Pr(>F)`[1]
```

We collected data on biomass (total of `r round(sum(BIOMASS$tot_bio), 0)` kg), density, and plant traits: area lost to herbivores, water content, leaf dry matter content and specific leaf area for `r length(unique(data$unified_names))` woody plant species from three tropical forest sites on elevations spanning `r 1900 - 200` m from 200 to 1900 m a.s.l. Low elevation is Wanang (200 m a.s.l.), Mid-elevation is Numba (700 m a.s.l.), and High elevation is Yawan (1900 m a.s.l.). We refer to the sites as Low, Mid- and High elevation throughout the text.

Figure 1. Median, 1st, second quadrilles, 1.5 IRQ distance and outliers in biomass, richness diversity and density at each location/elevation, but some Yawan sites were extremely productive.

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE}

library(ggplot2)
library(dplyr)

elev.bind <- rbind(BIOMASS %>% dplyr::select(site, garden, treatment, tot_bio), 
                   RICHNESS %>% dplyr::select(site, garden, treatment, sp_no), 
                   RICHNESS %>% dplyr::select(site, garden, treatment, simpson), 
                   DENSITY %>% dplyr::select(site, garden, treatment, tot.stem.no))

findoutlier <- function(x) {
  return(x < quantile(x, .25) - 1.5*IQR(x) | x > quantile(x, .75) + 1.5*IQR(x))
}

elevdata <- elev.bind %>% 
  mutate(value = ifelse(!is.na(tot_bio), tot_bio, 
                        ifelse(!is.na(sp_no), sp_no, 
                               ifelse(!is.na(simpson), simpson, tot.stem.no)))) %>%
  mutate(descriptor = ifelse(!is.na(tot_bio), "Total biomass [kg]", 
                        ifelse(!is.na(sp_no), "Number of species", 
                               ifelse(!is.na(simpson), "Simpson's diversity", "Abundance")))) %>%
  dplyr::select(site, garden, treatment, value, descriptor) %>%
  mutate(fsite = factor(site, levels = c("wanang", "numba","yawan"))) %>%
  arrange(descriptor, fsite, treatment, garden)

elevdataT <- elevdata %>% 
  mutate(valueTrans = ifelse(descriptor == "Simpson's diversity", 
                             value, log(value)))

outliers <- c()
for (desc in unique(elevdataT$descriptor)) {
  for (st in unique(elevdataT$site)) {
    for (trt in unique(elevdataT$treatment)) {
      
      print(paste(desc,st,trt))
      
      outliers <- c(outliers,findoutlier(pull(elevdataT %>% filter(descriptor == desc,
                          site == st,
                          treatment == trt), valueTrans)))

    }

  }
}
elevdataT$outlierBool <- outliers 
elevdataT <- elevdataT %>% mutate(outlier = ifelse(outlierBool, garden, ""))



ggplot(elevdataT, aes(y = valueTrans, x = fsite, label = garden))+
  geom_boxplot()+
  geom_text(aes(label=outlier), hjust = 1.2, vjust = -0.0005, na.rm=TRUE)+
  facet_grid(vars(descriptor), vars(treatment), scales = "free")+
  theme_bw()

```

Looking at the control plots Numba (the mid-elevation in our study) has the highest abundance and number of species. Predictably productivity decreases with elevation. Control plots in Numba are more variable than in other two elevations. Yawan has one site with lowest abundance (garden number seven).However no significant differences in variance were detected (Levene's and Bartellet's tests)

## General effects of biotic factors

We calculated log-response ratios for plant biomass, species richness, species diversity and stem density to be able to compare the effect sizes at individual elevations.

Table 1. Test results for over-dispersion all descriptors at three studied elevations.

```{r, echo=FALSE, results='show', fig.show='all', warning=FALSE, message=FALSE}
sjPlot::tab_df(lrr_test_df)
```

```{r,  echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE}

# Results of a GLS model with over-dispersion vs LM model for density LRR in the predator exclusion treatment.
trtdata <-  trtdata  <- DENSITY.LR %>%
    filter(treatment == 'p')

trtlm <- lm(lratio ~ 0 + site, data = trtdata)

trtgls <- nlme::gls(lratio ~ 0 + site, data = trtdata,
                 weights = varIdent(form = ~1|site))

summary(trtlm)
summary(trtgls)


aovtrt <- anova(trtlm)

testStat <- aovtrt$`F-value`
testP <- aovtrt$`p-value`
    
# Tukey post-hoc
emm <- emmeans(object = trtlm,
               specs = "site",
               adjust = "mvt")

mod_means <- multcomp::cld(object = emm,
                           Letters = letters)$.group

zero.dif.lm <- ifelse(summary(trtlm)$coefficients[,4] > 0.05, "","*")
zero.dif.gls <- ifelse(summary(trtgls)$tTable[,4] > 0.05, "","*")


lmres <- as_tibble(summary(trtlm)$coefficients)
lmres <- rename(lmres, Estimate = 'Estimate', 
               `Standard Error` = `Std. Error`, 
               `T-value` =`t value`,
               `P-value` = `Pr(>|t|)`)

glsres <- as_tibble(summary(trtgls)$tTable)
glsres <- rename(glsres,
                 Estimate = 'Value', 
                 `Standard Error` = "Std.Error", 
                 `T-value` = "t-value", 
                 `P-value` = 'p-value')

model_comp <- rbind(lmres, glsres)
model_comp$Site <- rep(c("Wanang", "Numba", "Yawan"), 2)
model_comp$Model <- rep(c("LM", "GLS"), each = 3)

```



Table S2. Two models testing difference of LRR of predator exclosures from zero at each elevation.

```{r}
sjPlot::tab_df(model_comp)
```

There is generally little evidence for the over-dispersion in the LRR values at individual elevations. Only woody stem density for the predator exclusion showed some evidence of over-dispersion. Including this in statistical modle (using 'varIdent(form = ~1|site)' as weights in the GLS function) showed significant difference of LRR in Yawan, that was not observed for LM model.

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE, fig.cap= "Figure 1. Magnitude and direction of fungi, insects and their predators on biomass, richness, diversity and density of woody plants along elevation gradient: Wanang (200 m a.s.l.); Numba (750 m a.s.l.); Yawan (1900 m a.s.l.). Log response ratio is a log-ratio of a given descriptor value from plots where a biotic factor was present to where it was absent. Grey points represent empirical values. Letters indicate statistically significant ($\\alpha$ = 0.05) differences for pairwise comparisons between elevations within a treatment-descriptor combination with Tukey correction for multiplicity. For better readability letters are given only in cases where any of the mean were either different form each other or different from zero. Zero effect are indicated with a dashed line. Stars in the upper index indicate significant ($\\alpha$ = 0.05) differences of the effect mean from zero (significance of the effect at a given site)", fig.width= 8, fig.height=8}

library(ggplot2)

# bio, dens, div, rich
panel_data <- data.frame()

dats <- list(biomass = BIOMASS.LR, 
             denssity = DENSITY.LR, 
             diversity = DIVERSITY.LR, 
             richness = RICHNESS.LR)

# Stack the data and rename descriptor names
for (file in names(dats)){
  print(file)
  dat <- dats[[file]]
  dat$descriptor <- ifelse(grepl("bio", file), "Biomass",
                           ifelse(grepl("dens", file), "Woody plant density",
                                  ifelse(grepl("div", file),"Diversity", "Richness")))
  dat <- dat[, c("site", "garden", "treatment", "lratio","descriptor")]
  panel_data <- rbind(dat, panel_data)
}

# Make a renamed factor variable for the treatments

panel_data$ftreatment <- panel_data$treatment

# Fix treatment names
panel_data$ftreatment[panel_data$ftreatment == "i"] <- "Insects"
panel_data$ftreatment[panel_data$ftreatment == "p"] <- "Birds, bats and ants"
panel_data$ftreatment[panel_data$ftreatment == "f"] <- "Fungi"
panel_data$ftreatment[panel_data$ftreatment == "h"] <- "Increased herbivory"
panel_data$ftreatment <- factor(panel_data$ftreatment,
                           levels = c("Fungi",
                                      "Insects",
                                      "Birds, bats and ants",
                                      "Increased herbivory"
                                      ))

# Set the transparency value
aph <- 0.5

# Create a factor variable for sites
panel_data$fsite <- factor(panel_data$site, labels = c("Wanang",
                                      "Numba",
                                      "Yawan"))

# Display panel plot
ggplot(panel_data, aes(x = fsite, y = lratio))+
  geom_jitter(width = 0.1, alpha = 0.1, size = 2)+
  
  # Group means
  stat_summary(fun = mean, na.rm = T,
               geom = "point", size = 2,
               alpha = aph)+
  
  stat_summary(fun.data = "mean_cl_boot",
               alpha = aph) + 
  
  # Annotations
  geom_text(data = panel_data %>%
              group_by(ftreatment, fsite) %>%
              summarise(mlr = mean(lratio)),
            aes(x = fsite, y = mlr + 1.5, group = ftreatment,
                label = lrr_panel_labs),
            size = 3)+
  
  theme_bw()+
  theme(strip.text = element_text(size =5.5),
        axis.text.x = element_text(angle = 45,
                                   hjust = 1))+
  geom_hline(yintercept = 0, lty = 2)+
  ylab("Log response ratio")+xlab("")+
  facet_grid(descriptor ~ ftreatment)

```

## Impact of treatments

Positive effect of pathogenic fungi on richness was found at low and high elevations (Fig. 1) and on density at low elevation.

Insects reduced biomass only at the mid-elevation, increased diversity at high and richness at high and low elevation. 

```{r}

# Check whether the RICHNESS.LR for predators is correct.
# trtdata <-  trtdata  <- RICHNESS.LR %>%
#     filter(treatment == 'p')

# trtlm <- lm(lratio ~ 0 + site, data = trtdata)

# summary(trtlm)

# Tukey post-hoc
# emm <- emmeans(object = trtlm,
#                specs = "site",
#                adjust = "mvt")

# mod_means <- multcomp::cld(object = emm,
#                            Letters = letters)$.group

```
At high elevation predator removal caused an increase in diversity, richness and density of woody plants. 

Increase in generalist herbivore abundance reduced biomass and woody plant density at low elevation and richness at low and high elevations.


## LRR correlations

In case of species richness only effect of insect and herbivore addition and removal had strong significant correlation with each other. Herbivore addition and removal were negatively correlated as expected. If there is a compensatory effect there should be no correlation (because when we remove one factor the other takes over and equalize the effect). Positive correlation rules out compensation. All positive correlations suggest bottom-up control.