---
title: "Data Analysis"
author: "Piotr Szefer"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, results='hide',warning=FALSE, message=FALSE)

```

# Experimental design

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE}
# The source file loads the data preparation script, where the raw data is read and summarised for further analyses
source('code/log_ratio_extraction.R')

library(ggplot2)
library(dplyr)
library(sjPlot)
library(AICcmodavg)
library(caTools)
library(randomForest)
library(rpart)
library(rpart.plot)
library(C50)
library(printr)
library(betapart)
library(lsmeans)
library(emmeans)
library(multcomp)
library(multcompView)


```

# Results

We collected data on biomass (total of `r round(sum(BIOMASS$tot_bio), 0)` kg), density, and plant traits: area lost to herbivores, water content, leaf dry matter content and specific leaf area for `r length(unique(data$unified_names))` woody plant species from three tropical forest sites: low elevation (Wanang, 200 m a.s.l.); mid-elevation (Numba, 700 m a.s.l.); high elevation (Yawan, 1900 m a.s.l.). We refer to the sites as Low, Mid- and High elevation throughout the text.

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE}

elev.bind <- rbind(BIOMASS %>% dplyr::select(site, garden, treatment, tot_bio), 
                   RICHNESS %>% dplyr::select(site, garden, treatment, sp_no), 
                   RICHNESS %>% dplyr::select(site, garden, treatment, simpson), 
                   DENSITY %>% dplyr::select(site, garden, treatment, tot.stem.no))

findoutlier <- function(x) {
  return(x < quantile(x, .25) - 1.5*IQR(x) | x > quantile(x, .75) + 1.5*IQR(x))
}

elevdata <- elev.bind %>% 
  mutate(value = ifelse(!is.na(tot_bio), tot_bio, 
                        ifelse(!is.na(sp_no), sp_no, 
                               ifelse(!is.na(simpson), simpson, tot.stem.no)))) %>%
  mutate(descriptor = ifelse(!is.na(tot_bio), "Total biomass [kg]", 
                        ifelse(!is.na(sp_no), "Number of species", 
                               ifelse(!is.na(simpson), "Simpson's diversity", "Abundance")))) %>%
  dplyr::select(site, garden, treatment, value, descriptor) %>%
  mutate(fsite = factor(site, levels = c("wanang", "numba","yawan"))) %>%
  arrange(descriptor, fsite, treatment, garden)

elevdataT <- elevdata %>% 
  mutate(valueTrans = ifelse(descriptor == "Simpson's diversity", 
                             value, log(value)))

outliers <- c()
for (desc in unique(elevdataT$descriptor)) {
  for (st in unique(elevdataT$site)) {
    for (trt in unique(elevdataT$treatment)) {
      
      # print(paste(desc,st,trt))
      
      outliers <- c(outliers,findoutlier(pull(elevdataT %>% filter(descriptor == desc,
                          site == st,
                          treatment == trt), valueTrans)))

    }

  }
}
elevdataT$outlierBool <- outliers 
elevdataT <- elevdataT %>% mutate(outlier = ifelse(outlierBool, garden, ""))

# Tests and labels

labelsS1 <- data.frame()

for (desc in unique(elevdataT$descriptor)){
  for (trt in unique(elevdataT$treatment)){
    subdat <- elevdataT %>% filter(descriptor == desc & treatment == trt)
    subdat %>% 
      group_by(fsite) %>%
      summarize(ycoord = mean(valueTrans)) %>%
      dplyr::select(ycoord)
    mod1 <- lm(valueTrans ~ fsite, data = subdat)
    anova(mod1)
    lbls <- cld(object = emmeans(mod1, specs = "fsite"),Letters = c("a","b","c"))$.group
    
    # print(paste(desc, trt, paste0(lbls, collapse = "")))
    
    labelsS1 <- rbind(labelsS1, data.frame(descriptor = desc,
                                           sites = factor(c("wanang", "numba", "yawan"),
                                                          levels = c("wanang", "numba", "yawan")),
                                           labels = lbls,
                                           treatment = trt,
                                           ycoord = subdat %>% 
                                             group_by(fsite) %>%
                                             summarize(ycoord = mean(valueTrans)) %>%
                                             dplyr::select(ycoord)))
  }
}



```

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE, fig.cap=" Figure S1. Median, 1st, 2nd quadrilles, 1.5 IRQ distance, and outliers (labeled) for logarithm of biomass, richness diversity, and density at three studied locations/elevations. Letters indicate statisitcal differences at the $\alpha$ = 0.05 level from the post hos Tukey test."}
# Plot
ggplot(elevdataT, aes(y = valueTrans, x = fsite, label = garden))+
  geom_boxplot()+
  geom_text(aes(label=outlier), 
            size = 2, 
            alpha = 0.6,
            hjust = 1.2, 
            vjust = -0.0005, 
            na.rm=TRUE) +
  facet_grid(vars(descriptor), vars(treatment), scales = "free")+
  geom_text(data = labelsS1,
            aes(x = sites, y = ycoord + 2.5, group = trt,
                label = labels),
            size = 3) +
  theme_bw() +
  theme(strip.text = element_text(size =5.5),
        axis.text.x = element_text(angle = 45,
                                   hjust = 1))+
  xlab("")

```

Elevations were similar in their baseline productivity (total biomass). At the high elevation the plant abundance, richness and diversity was significantly higher than at the low elevation. Mid elevation has many outliers. However, no significant differences in variance were detected (Table S1)

## General effects of biotic factors
We calculated log-response ratios for plant biomass, species richness, species diversity and stem density to be able to compare the effect sizes at individual elevations.

Table 1. Test results for over-dispersion all descriptors at three studied elevations.
```{r, echo=FALSE, results='show', fig.show='all', warning=FALSE, message=FALSE}
sjPlot::tab_df(lrr_test_df)
```

```{r,  echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE}

# Results of a GLS model with over-dispersion vs LM model for density LRR in the predator exclusion treatment.
trtdata <-  trtdata  <- DENSITY.LR %>%
    filter(treatment == 'p')

trtlm <- lm(lratio ~ 0 + site, data = trtdata)

trtgls <- nlme::gls(lratio ~ 0 + site, data = trtdata,
                 weights = varIdent(form = ~1|site))

# summary(trtlm)
# summary(trtgls)


aovtrt <- anova(trtlm)

testStat <- aovtrt$`F-value`
testP <- aovtrt$`p-value`
    
# Tukey post-hoc
emm <- emmeans(object = trtlm,
               specs = "site",
               adjust = "mvt")

mod_means <- multcomp::cld(object = emm,
                           Letters = letters)$.group

zero.dif.lm <- ifelse(summary(trtlm)$coefficients[,4] > 0.05, "","*")
zero.dif.gls <- ifelse(summary(trtgls)$tTable[,4] > 0.05, "","*")


lmres <- as_tibble(summary(trtlm)$coefficients)
lmres <- rename(lmres, Estimate = 'Estimate', 
               `Standard Error` = `Std. Error`, 
               `T-value` =`t value`,
               `P-value` = `Pr(>|t|)`)

glsres <- as_tibble(summary(trtgls)$tTable)
glsres <- rename(glsres,
                 Estimate = 'Value', 
                 `Standard Error` = "Std.Error", 
                 `T-value` = "t-value", 
                 `P-value` = 'p-value')

model_comp <- rbind(lmres, glsres)
model_comp$Site <- rep(c("Wanang", "Numba", "Yawan"), 2)
model_comp$Model <- rep(c("LM", "GLS"), each = 3)

```


Table S2. Two models testing difference of LRR of predator exclosures from zero at each elevation. General Least Squares assumes over-dispersion in the data
```{r, results='asis'}
sjPlot::tab_df(model_comp)
```

There is generally no evidence for the over-dispersion in the LRR values at individual elevations. Only woody stem density for the predator exclusion showed some evidence of over-dispersion. Including this in statistical modle (using 'varIdent(form = ~1|site)' as weights in the GLS function) showed significant difference of LRR in Yawan, that was not observed for LM model.

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE, fig.cap= "Figure 1. Magnitude and direction of fungi, insects and their predators on biomass, richness, diversity and density of woody plants along elevation gradient: Wanang (200 m a.s.l.); Numba (750 m a.s.l.); Yawan (1900 m a.s.l.). Log response ratio is a log-ratio of a given descriptor value from plots where a biotic factor was present to where it was absent. Grey points represent empirical values. Letters indicate statistically significant ($\\alpha$ = 0.05) differences for pairwise comparisons between elevations within a treatment-descriptor combination with Tukey correction for multiplicity. For better readability letters are given only in cases where any of the mean were either different form each other or different from zero. Zero effect are indicated with a dashed line. Stars in the upper index indicate significant ($\\alpha$ = 0.05) differences of the effect mean from zero (significance of the effect at a given site)", fig.width= 8, fig.height=8}

# bio, dens, div, rich
panel_data <- data.frame()

dats <- list(biomass = BIOMASS.LR, 
             denssity = DENSITY.LR, 
             diversity = DIVERSITY.LR, 
             richness = RICHNESS.LR)

# Stack the data and rename descriptor names
for (file in names(dats)){
  # print(file)
  dat <- dats[[file]]
  dat$descriptor <- ifelse(grepl("bio", file), "Biomass",
                           ifelse(grepl("dens", file), "Woody plant density",
                                  ifelse(grepl("div", file),"Diversity", "Richness")))
  dat <- dat[, c("site", "garden", "treatment", "lratio","descriptor")]
  panel_data <- rbind(dat, panel_data)
}

# Make a renamed factor variable for the treatments

panel_data$ftreatment <- panel_data$treatment

# Fix treatment names
panel_data$ftreatment[panel_data$ftreatment == "i"] <- "Insects"
panel_data$ftreatment[panel_data$ftreatment == "p"] <- "Birds, bats and ants"
panel_data$ftreatment[panel_data$ftreatment == "f"] <- "Fungi"
panel_data$ftreatment[panel_data$ftreatment == "h"] <- "Increased herbivory"
panel_data$ftreatment <- factor(panel_data$ftreatment,
                           levels = c("Fungi",
                                      "Insects",
                                      "Birds, bats and ants",
                                      "Increased herbivory"
                                      ))

# Set the transparency value
aph <- 0.5

# Create a factor variable for sites
panel_data$fsite <- factor(panel_data$site, labels = c("Low",
                                      "Mid",
                                      "High"))

# Display panel plot
ggplot(panel_data, aes(x = fsite, y = lratio))+
  geom_jitter(width = 0.1, alpha = 0.1, size = 2)+
  
  # Group means
  stat_summary(fun = mean, na.rm = T,
               geom = "point", size = 2,
               alpha = aph)+
  
  stat_summary(fun.data = "mean_cl_boot",
               alpha = aph) + 
  
  # Annotations
  geom_text(data = panel_data %>%
              group_by(ftreatment, fsite) %>%
              summarise(mlr = mean(lratio)),
            aes(x = fsite, y = mlr + 1.5, group = ftreatment,
                label = lrr_panel_labs),
            size = 3)+
  
  theme_bw()+
  theme(strip.text = element_text(size =5.5),
        axis.text.x = element_text(angle = 0,
                                   hjust = 0.5))+
  geom_hline(yintercept = 0, lty = 2)+
  ylab("Log response ratio")+xlab("")+
  facet_grid(descriptor ~ ftreatment)

```

## Impact of treatments

Positive effect of pathogenic fungi on richness was found at low and high elevations (Fig. 1) and on density at low elevation. Insects reduced biomass only at the mid-elevation, increased diversity at high and richness at high and low elevation. At high elevation predator removal caused an increase in diversity, richness and density of woody plants. Increase in generalist herbivore abundance reduced biomass and woody plant density at low elevation and richness at low and high elevations.


```{r}

# Check whether the RICHNESS.LR for predators is correct.
# trtdata <-  trtdata  <- RICHNESS.LR %>%
#     filter(treatment == 'p')

# trtlm <- lm(lratio ~ 0 + site, data = trtdata)

# summary(trtlm)

# Tukey post-hoc
# emm <- emmeans(object = trtlm,
#                specs = "site",
#                adjust = "mvt")

# mod_means <- multcomp::cld(object = emm,
#                            Letters = letters)$.group

```

## LRR correlations

Differences of LRR averages from zero may suggest that the effects are random, generally weak and noisy. We now look at the LRR correlation for different treatments to probe some possible mechanisms of the biotic factors' action.

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE, fig.cap= "Figure 2. ...", fig.width= 10, fig.height= 10}

# LRR correlation plot
ftreats <- unique(panel_data$ftreatment)

fdat <- panel_data %>%
  filter(ftreatment == ftreats[1])%>%
  arrange(descriptor, site, garden)

hdat <- panel_data %>%
  filter(ftreatment == ftreats[2])%>%
  arrange(descriptor, site, garden)

idat <- panel_data %>%
  filter(ftreatment == ftreats[3])%>%
  arrange(descriptor, site, garden)

pdat <- panel_data %>%
  filter(ftreatment == ftreats[4])%>%
  arrange(descriptor, site, garden)

# chdat <- panel_data %>%
#   filter(ftreatment == ftreats[5])%>%
#   arrange(descriptor, site, garden)

# Create one dataset
pdpairs <- panel_data %>%
  group_by(descriptor, site, garden) %>%
  summarise() # Summarise based on what??????

# Add columns with LRRs
pdpairs$f <- fdat$lratio
pdpairs$h <- hdat$lratio
pdpairs$i <- idat$lratio
pdpairs$p <- pdat$lratio

biolrr <- pdpairs %>% filter(descriptor == "Biomass")
biocont <- BIOMASS  %>% filter(treatment == "c") %>%
  arrange(as.character(site), garden)

cpdata <- data.frame(descriptor = rep(pdpairs$descriptor,2),
                     site = rep(pdpairs$site,2),
                     garden = rep(pdpairs$garden),
                     x = c(pdpairs$h,
                           pdpairs$p),
                     y = rep(pdpairs$i, 2),
                     response = rep(c("Elevated herbivory effect",
                                      "Top predators effect"), 
                                    each = length(pdpairs$descriptor))) 

lrr.cor.test.data <- c()

for (resp in unique(cpdata$response))   {
  for (desc in unique(cpdata$descriptor)){
    for (loc in unique(cpdata$site))     {
      
      # print(paste(resp, desc,loc))
      
      lrrtd <- cpdata %>%
        filter(response == resp,
               descriptor == desc,
               site == loc)
      
      # np.test.p <- cor.test(lrrtd$x, lrrtd$y, method = c('pearson'))$p.value
      # Test for noramlity
      # print(shapiro.test(lrrtd$x))
      # print(shapiro.test(lrrtd$y))
      
      lm.test.p <- summary(lm(lrrtd$y~lrrtd$x, data = lrrtd))$coefficients[2,4]
      
      # print(lm.test.p)
      
      lrr.res <- data.frame(response = resp,
                            descriptor = desc,
                            site = loc,
                            non.param.p = ifelse(lm.test.p<0.05,"signif","ns"))
      lrr.cor.test.data <- rbind(lrr.cor.test.data, lrr.res)
      
    }
  }
}

lrr.cor.test.data -> lctd

cpdata$sign <- ""

sign.dat <- lctd[lctd$non.param.p == "signif",]

for(row in 1:dim(sign.dat)[1]){
  resp <- sign.dat[row, ]$response
  desc <- sign.dat[row, ]$descriptor
  loc <- sign.dat[row, ]$site
  
  c1 <- cpdata$response == resp
  c2 <- cpdata$descriptor == desc
  c3 <- cpdata$site == loc
  
  cpdata[c1 & c2 & c3, ]$sign <- "signif"
}

# ggplot(cpdata, aes(x = x, y = y)) +
#   geom_point(size = 2, alpha = 0.4)+
#   stat_smooth(data = cpdata %>%
#                 filter(sign == "signif"),
#               method ="lm")+
#   geom_hline(yintercept = 0)+
#   geom_vline(xintercept = 0)+
#   ylab("Effect size of insects")+
#   xlab("Effect size")+
#   theme_bw()+
#   facet_grid(response*descriptor~site)

```


#### OBSERVATIONS

Correlation between LRR of insect effects were not very common and were observed in `r 9/(3*8) * 100` % of cases. Correlations were more often found in Yawan (five out of eight studied correlations) than in Numba (four out of eight) and no significant correlation was found in Wanang. If we also include correlations between predator exclusion (P) and P+A this ratio gets significantly higher for Yawan (9 out of 12 correlations). 

All observed correlations of the top-predators effects were positively correlated with insect effects, whereas all effects of herbivore addition were negatively correlated with the insect effects.

#### EXPLANATION

If a plant community has a potential to be strongly negatively affected by insects (negative LRR of insects, strong top-down control), then the P+A would result in weaker or positive effects of additional generalist herbivores. Top down control seem to be stronger in the highlands and we see more frequent correlation of the LRR's. (Model where Intra-guild predators are being strongly limited by top predators.)

What exactly happened after addition can however only be speculated here. In case of a  strong bottom-up control should not result in any sort of correlation like in Wanang. What I think happened was that spiders could be more active in the exclosures which resulted in their effects being similar to that of a simple exclusion.

A few aspects of insect effects on plants can be important here: 
If community is saturated with herbivores (Konno) then addition may have negative results.
Herbivore resource limitation type (relative or absolute). Feeding mode change, adaptive trade off, risk avoidance. All these can only be speculated.

Generalists are worse in consuming any individual plant biomass, therefore they may have positive effects on plants, when natural insect communities have negative effects. It is possible that addition of herbivores cause som disruption in the functioning of the insect community effect on vegetation.
There were no correlation between factorsâ€™ effects on vegetation at the low elevation. Herbivore addition and removal were not correlated as expected by the strong bottom-up control.


Simulation showed that it cannot be simply an effect of the effect-abundance relationship between abundance of insects and their effect (quadratic and linear function result in positive relationship).

Top-down effects of predators and their positive correlation with insect effects can be explained well by the bottom-up control of insects by plants. It was also assumed in the above simulations. Empirically we do not observe any correlation between insect abundance and strength of the effect (lrr_simualtions.R at the end). There is also no correlation between richness of a community and its LRR for any of the treatments (lrr_simulations.R).


#### SOME DISCLAIMERS

It is noteworthy that plots where herbivores were added were also covered with nets to prevent increased predation, wich is known to be correlated with increased leaf damage (Katka). Therefore it cannot be interpreted directly as a simple increase in herbivory pressure even though this is what should be happening assuming simple chain model and top-down control by top-predators. 
We do not know the faith of the added predators. It is most likely that they did not cause a permanent increase in the species abundance (graph here). However, herbivore damage in general was...

### Predator exclusion and predator exclusion with insect addition

The hypothesis that I have stated above, about increased activity of spiders in exclosures is here being investigated further. I want to see whether the addition of herbivores has a positive correlation with the regular exclosures. Positive correlation would suggest that the herbivore addition had little to no effect, and that spiders responding to a lack of predators would control the herbivore population even with boosted abundances.

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE, fig.cap= "Figure 2. Log-Response Ratio correlations for insects and fungi effects on bimoass, diversity adn density of woody plants"}

fidata <- data.frame(descriptor = pdpairs$descriptor,
                     site = pdpairs$site,
                     garden = rep(pdpairs$garden),
                     x = pdpairs$p,
                     y = pdpairs$h)

lrr.cor.test.data <- c()

# for (resp in unique(fidata$response))   {
  for (desc in unique(fidata$descriptor)){
    for (loc in unique(fidata$site))     {
      
      # print(paste(desc,loc))
      
      lrrtd <- fidata %>%
        filter(descriptor == desc,
               site == loc)
      
      # Test for normality
      # print(shapiro.test(lrrtd$x))
      # print(shapiro.test(lrrtd$y))
      
      lm.test.p <- summary(lm(lrrtd$y~lrrtd$x, data = lrrtd))$coefficients[2,4]
      
      # print(lm.test.p)
      
      lrr.res <- data.frame(descriptor = desc,
                            site = loc,
                            non.param.p = ifelse(lm.test.p<0.05,"signif","ns"))
      lrr.cor.test.data <- rbind(lrr.cor.test.data, lrr.res)
      
    }
  }
# }

lrr.cor.test.data -> lctd

fidata$sign <- ""

sign.dat <- lctd[lctd$non.param.p == "signif",]

for(row in 1:dim(sign.dat)[1]){
  # resp <- sign.dat[row, ]$response
  desc <- sign.dat[row, ]$descriptor
  loc <- sign.dat[row, ]$site
  
  # c1 <- cpdata$response == resp
  c2 <- fidata$descriptor == desc
  c3 <- fidata$site == loc
  
  fidata[c2 & c3, ]$sign <- "signif"
}

# ggplot(fidata, aes(x = x, y = y)) +
#   geom_point(size = 2, alpha = 0.4)+
#   stat_smooth(data = fidata %>%
#                 filter(sign == "signif"),
#               method ="lm")+
#   geom_hline(yintercept = 0)+
#   geom_vline(xintercept = 0)+
#   xlab("Predator removal")+
#   ylab("Predator removal and insect addition")+
#   theme_bw()+
#   facet_grid(descriptor~site)

```

From the figure we see that there is usually no correlation in Wanang and Numba but it is always present in Yawan. Moreover it is not positive but negative. This means that when we observer negative effect of predator removal on biomass we can expect to have positive effect of insect addition to the exclosure. In cases where the effect of predators is positive, we would get a negative effect of insect addition.

### Fungi vs insect correlation
No correlation should be observed in case of compensatory effect
In case of species richness only effects of insect, herbivore addition and herbivore removal were correlated. Herbivore addition and removal were negatively correlated as expected. If there is a compensatory effect there should be no correlation (because when we remove one factor the other takes over and equalize the effect). Positive correlation rules out compensation. A positive correlations would suggest bottom-up control.

```{r, echo=FALSE, results='hide', fig.show='all', warning=FALSE, message=FALSE, fig.cap= "Figure 2. Log-Response Ratio correlations for insects and fungi effects on bimoass, diversity adn density of woody plants"}

fidata <- data.frame(descriptor = pdpairs$descriptor,
                     site = pdpairs$site,
                     garden = rep(pdpairs$garden),
                     x = pdpairs$i,
                     y = pdpairs$f)

lrr.cor.test.data <- c()

# for (resp in unique(fidata$response))   {
  for (desc in unique(fidata$descriptor)){
    for (loc in unique(fidata$site))     {
      
      # print(paste(desc,loc))
      
      lrrtd <- fidata %>%
        filter(descriptor == desc,
               site == loc)
      
      # Test for normality
      # print(shapiro.test(lrrtd$x))
      # print(shapiro.test(lrrtd$y))
      
      lm.test.p <- summary(lm(lrrtd$y~lrrtd$x, data = lrrtd))$coefficients[2,4]
      
      # print(lm.test.p)
      
      lrr.res <- data.frame(descriptor = desc,
                            site = loc,
                            non.param.p = ifelse(lm.test.p<0.05,"signif","ns"))
      lrr.cor.test.data <- rbind(lrr.cor.test.data, lrr.res)
      
    }
  }
# }

lrr.cor.test.data -> lctd

fidata$sign <- ""

sign.dat <- lctd[lctd$non.param.p == "signif",]

for(row in 1:dim(sign.dat)[1]){
  # resp <- sign.dat[row, ]$response
  desc <- sign.dat[row, ]$descriptor
  loc <- sign.dat[row, ]$site
  
  # c1 <- cpdata$response == resp
  c2 <- fidata$descriptor == desc
  c3 <- fidata$site == loc
  
  fidata[c2 & c3, ]$sign <- "signif"
}

# ggplot(fidata, aes(x = x, y = y)) +
#   geom_point(size = 2, alpha = 0.4)+
#   stat_smooth(data = fidata %>%
#                 filter(sign == "signif"),
#               method ="lm")+
#   geom_hline(yintercept = 0)+
#   geom_vline(xintercept = 0)+
#   ylab("Effect size of insects")+
#   xlab("Effect size of fungi")+
#   theme_bw()+
#   facet_grid(descriptor~site)


```


## COMMUNITY COMPOSITION

At each elevation insect exclusion significantly affected the community composition [but only when all treatments were included, in pairwise comparisons, i.e., C vs I the composition was not changed significantly]. Fungicide treatment significantly affected the full plant community composition only at the highest elevation (Fig, 3; Appendix I, Tab. S1).

```{r}

library(vegan)
library(cowplot)

# 1. Load the data
COMMDATA <- t(COMMDATA)
COMMVARS

# Select only i,c,p,f
COMM.SEL <- COMMDATA[grepl("i|c$|p|f|_h", rownames(COMMDATA)), ]
VARS.SEL <- COMMVARS[grepl("i|c$|p|f|_h", COMMVARS$plotid), ]

treats.to.consider <- c("i","c","h","f","p")

# Dummy-coding of the treatments
COMMVARS <- COMMVARS %>%
  mutate(f = ifelse(treatment == "f", 1, 0),
         h = ifelse(treatment == "h", 1, 0),
         p = ifelse(treatment == "p", 1, 0),
         c = ifelse(treatment == "c", 1, 0),
         i = ifelse(treatment == "i", 1, 0))

# RDA at each elevation

## 3.1 Analyses for each elevation
ord.list <- list()
plot.list <- list()

for(site.id in substr(unique(COMMVARS$site),1,1)){
  
  # print(site.id)
  
  SUB.VARS <- COMMVARS %>%
    filter(grepl(paste('^', site.id, sep = ""), site) & treatment %in% treats.to.consider)
  
  SUB.DATA <- COMMDATA[SUB.VARS$plotid, ]
  SUB.DATA <- decostand(SUB.DATA, method = 'hellinger')
  # Perform RDA and ANOVA and print the results
  rdamod <- rda(as.data.frame(SUB.DATA)~f+h+p+i+Condition(garden), 
                data = SUB.VARS)
  
  ord.list[[site.id]] <- rdamod
  
  h <- how(blocks = SUB.VARS$garden)
  
  # print(anova(rdamod, permutations = h, by = "terms"))
  
  # Goodness
  gdnsof <- goodness(rdamod, model = "CCA", proportional = T)
  gof2ax <- gdnsof[,1] + gdnsof[,2]
  cgof <- gof2ax[gof2ax > 0.2]
  cgof <- sort(cgof, decreasing = T)
  sign.names <- names(cgof[!is.na(cgof) & !is.infinite(cgof)])
  
  colors <- as.numeric(as.factor(SUB.VARS$treatment))
  
  # Alternative way to obtain these
  rda.dat <- list(sites = rdamod$CCA$wa[, c(1,2)],
                  species = rdamod$CCA$v[, c(1,2)],
                  biplot = rdamod$CCA$biplot[, c(1,2)])
  
  sites.dat <- as.data.frame(rda.dat$sites) %>%
    mutate(codes = rownames(rda.dat$sites),
           treats = ifelse(grepl("c", codes),"c",
                           ifelse(grepl("f", codes),"f", 
                                  ifelse(grepl("h", codes), "h", 
                                         ifelse(grepl("i", codes), "i","p")))),
           shapes = as.numeric(as.factor(treats)))
  
  species.dat <- as.data.frame(rda.dat$species) %>%
    mutate(names = rownames(as.data.frame(rda.dat$species)))
  
  arrow.dat <- as.data.frame(rda.dat$biplot) %>%
    mutate(treats = rownames(as.data.frame(rda.dat$biplot)))
  
  if(site.id == "y"){
    arr.col <- c("red","black","black","red")
    arr.lwd <- c(0.5,0.1,0.1,0.5)
    arr.lty <- c(1,2,2,1)
  } else {arr.col <- c("black","black","black","red")
  arr.lwd <- c(0.1,0.1,0.1,0.5)
  arr.lty <- c(2,2,2,1)
  }
  
  p1 <- ggplot(sites.dat,aes(x = RDA1, y = RDA2))+
    geom_point(aes(colour = treats), pch = sites.dat$shapes+14) + 
    geom_hline(yintercept = 0, lty = 2, alpha = 0.5) + 
    geom_vline(xintercept = 0, lty = 2, alpha = 0.5) + 
    geom_segment(data = arrow.dat, aes(x = 0, y = 0, 
                                       xend = RDA1, yend = RDA2),
                 arrow = arrow(length=unit(0.30,"cm"), 
                               ends="last", 
                               type = "closed"),
                 alpha = 0.8, 
                 col = arr.col,
                 lwd = arr.lwd,
                 lty = arr.lty)+
    geom_text(data = arrow.dat, aes(x = RDA1*1.1, y = RDA2*1.1, 
                                    label = treats),
              cex = 5)+
    theme_minimal()
  
  # scalar = 2.5
  
  p2 <- ggplot(species.dat, aes(x = RDA1*1.1, y = RDA2*1.1)) + 
    geom_text(data = species.dat %>%
                filter(names %in% sign.names), 
              aes(label = names, alpha = 0.2))+
    geom_segment(data = arrow.dat, aes(x = 0, y = 0, 
                                       xend = RDA1, yend = RDA2),
                 arrow = arrow(length=unit(0.30,"cm"), 
                               ends="last", 
                               type = "closed"),
                 alpha = 0.8, 
                 col = arr.col,
                 lwd = arr.lwd,
                 lty = arr.lty)+
    geom_text(data = arrow.dat, aes(x = RDA1*1.1, y = RDA2*1.1, 
                                    label = treats))+
    theme_minimal()
  
  plot.list[[site.id]] <- list(sites.ord = as_grob(p1),
                               species.ord = as_grob(p2))
  
}

## 3.2 Plot the ordination ----
ggpubr::ggarrange(plot.list[["w"]]$sites.ord,
                  plot.list[["w"]]$species.ord,
                  plot.list[["n"]]$sites.ord,
                  plot.list[["n"]]$species.ord,
                  plot.list[["y"]]$sites.ord,
                  plot.list[["y"]]$species.ord, ncol = 2, nrow = 3)

```

### Bray-Curtis dissimilarity

BC dissimilarity at the control plots was higher in Wanang than in Numba. Addition of herbivores created a monotonic decrease in dissimilarity with elevation (Fig. 4, reduction of dissimilarity means higher predictability of the plant community). In Wanang species composition changed mainly through turnover of species, in contrast to two other sites, where community changed through changes in the abundance structure (gradient component). 1. Baseline (?) species turnover is highest in Wanang. Gradient changes are smaller in wanang than in Numba. 2. Fungicide did not change the character of the community structure and assembly (patterns are similar in the case of both control and fungicide treatment). 3. Herbivore addition monotonically reduced dissimilarity (plots within the treatment were more similar to each other, reduced unpredictability of succession) by reducing it substantially in Yawan. This was caused by an increase in balanced component in numba and its reduction in Yawan. This means that species turnover between sites was reduced by additional herbivorous insects at the highest elevation. However, in both of these sites balanced component was similar. It was high in W and did not change there. 4. Insect removal monotonically reduces plant species turnover. Does not change the pattern of dissimilarity between elevations but substantially increases gradient component in Yawan (it increased slightly gradient component in Wanang and reduced significantly in Numba). Insect removal significantly reduced the species turnover (balanced component) in Yawan, and increased it in Numba. This means that the presence of insects (opposite of what the treatment does) increases species turnover in Y and reduces species turnover in N. Simultaneously it increase gradient component in Wanang and reduces it in Numba. Interestingly in Yawan further increase of herbivore pressure has the opposite effect again it brings it back to the previous level. Having additional herbivores has the same effect as not having insects at all in case of the balanced component. Predator treatmen is the same. In case of the gradient component only removal of insects was able to change it as indicated above. And only in wanang and numba. 5. Top-predators increase balanced and gradient component similar to insecticide treatement in Numba. Similarly to H and I it reduces balanced component in Yawan. But has no effect on BC dissimilarity. In Numba also reduce gradient component but does not do that in Yawan. Between sites: Balanced component is lowest in Yawan general BC dissimilarity is lowest in Yawan and gradient in Yawan is higher in Yawan than in Numba but similar to that in Wanang.

```{r}
# csites <- grepl("_c\\b", COMMVARS$plotid)
# fsites <- grepl("_f", COMMVARS$plotid)
# isites <- grepl("_i", COMMVARS$plotid)
# hsites <- grepl("_h", COMMVARS$plotid)
# psites <- grepl("_p", COMMVARS$plotid)

# wsites <- COMMVARS$site == "wanang"
# nsites <- COMMVARS$site == "numba"
# ysites <- COMMVARS$site == "yawan"

# B-C dissimilarities in C plots between sites

# cdatc <- COMMDATA[grepl("c$", rownames(COMMDATA)), ]
# cvars <- COMMVARS[rownames(cdatc), ]

# Comparisons between
# wc.beta <- beta.pair.abund(COMMDATA[COMMVARS[wsites & csites,]$plotid,  ])

beta.df <- data.frame()

# siteid <- "^w"
# treat <- "_c\\b"

for(siteid in c("^w","^y","^n")){
  for(treat in c("_c\\b","_f","_h","_i","_p")){

    # Subset the data
    nms <- rownames(COMMDATA)
    sel.nms <- nms[grepl(siteid, nms) & grepl(treat, nms)]
    site.treat.comm <- COMMDATA[sel.nms,]

    # Calculate beta diversity
    subbeta <- beta.pair.abund(site.treat.comm)

    # Add to a data frame
    balanced.df <- data.frame(site = siteid,
                              treat = treat,
                              vals = as.numeric(subbeta$beta.bray.bal),
                              component = "balanced")

    gradient.df <- data.frame(site = siteid,
                              treat = treat,
                              vals = as.numeric(subbeta$beta.bray.gra),
                              component = "gradient")

    bray.df <- data.frame(site = siteid,
                              treat = treat,
                              vals = as.numeric(subbeta$beta.bray),
                              component = "bray")

    sub.df <- rbind(balanced.df, gradient.df, bray.df)

    # Merge the data-set
    beta.df <- rbind(beta.df,sub.df)

  }
}

# beta.df

# Fix the site order
beta.df$fsite <- factor(beta.df$site, levels = c("^w","^n","^y"),
                        labels = c("w","n","y"))

# Transform 0s to 0.001 and 1s to 0.999
beta.df$trans.vals = ifelse(beta.df$vals == 1, 0.999999,
                            ifelse(beta.df$vals == 0, 0.000001, beta.df$vals))

# Tests for individual facets
cld.dat = data.frame()
prws.comp <- list()

# CLD data for comparisons between elevations
for (comp in unique(beta.df$component)){
  for (trt in unique(beta.df$treat)){

    test.df <- beta.df %>%
      filter(treat == trt,
             component == comp)

    mod1 <- betareg::betareg(trans.vals ~ fsite, data = test.df)

    lsmod1 <- lsmeans(mod1,
                      pairwise ~ fsite,
                      adjust="tukey")

    groups <- cld(lsmod1, Letters = c("abcdefg"))

    y_loc = test.df %>%
      group_by(fsite) %>%
      summarise(y_loc = mean(trans.vals))

    sub.cld <- data.frame(component = comp,
               treat = trt,
               fsite = groups$fsite,
               gr.label = groups$.group,
               y_loc = y_loc$y_loc[order(groups$fsite)])

    prws.comp[[paste(comp,trt)]] <- lsmod1

    cld.dat = rbind(cld.dat, sub.cld)

  }
}

pairwise.comp.res <- data.frame()
for (comp in unique(beta.df$component)){

  for (ste in unique(beta.df$fsite)){
    # print(comp)
    # print(ste)

    test.df <- beta.df %>%
      filter(fsite == ste,
             component == comp)

    # print(test.df)

    mod1 <- betareg::betareg(trans.vals ~ treat, data = test.df)

    breg.table <- summary(mod1)$coefficients$mean
    breg.pvals <- breg.table[,4]

    y_loc = test.df %>%
      group_by(treat) %>%
      summarise(y_loc = mean(trans.vals))

    pcr.row <- data.frame(comp = comp,
                          fsite = ste,
                          component = comp,
                          treat = names(breg.pvals),
                          p.vals = breg.pvals,
                          y_loc = y_loc$y_loc,
                          y_loc_trt = y_loc$treat)

    pcr.row <- pcr.row %>%
      mutate(label = ifelse(p.vals <= 0.05 & treat != "(Intercept)", "*",""))

    pairwise.comp.res <- rbind(pairwise.comp.res,pcr.row)

  }
}

beta.part.plot1 <- ggplot(beta.df, aes(x = fsite, y = vals))+
  geom_jitter(width = 0.1, alpha = 0.2, shape = 16, size = 1.8)+
  stat_summary(fun.y = mean, na.rm = T,
               geom = "point", size = 3, col = "gray30")+
  stat_summary(fun.data = "mean_cl_boot", col = "gray30")+
  stat_summary(fun.y = mean, aes(group = treat),
               geom = "line", alpha = 0.8, col = "gray30", lty = 2)+
  geom_text(data = cld.dat,
            aes(x = fsite, y = y_loc + 0.5,
                label = gr.label),
            size = 3)+
  facet_grid(cols = vars(component), rows = vars(treat)) + 
  theme_bw()

# Plot for the component comparisons
pairwise.comp.res$fsite <- factor(pairwise.comp.res$fsite,
                                  levels = c("w","n","y"))

# Alternative boxplot
beta.part.plot2 <- ggplot(beta.df, aes(x = treat, y = vals))+
  geom_boxplot()+
  # stat_summary(fun.y = mean, na.rm = T,
  #              geom = "point", size = 3, col = "gray30")+
  # stat_summary(fun.data = "mean_cl_boot", col = "gray30")+
  geom_text(data = pairwise.comp.res,
            aes(x = y_loc_trt, y = y_loc + 0.5,
                label = label), cex = 6,  col = "red")+
  facet_grid(component ~ fsite) + 
  theme_bw()
```

```{r, fig.width=10, fig.height=16}
ggpubr::ggarrange(beta.part.plot1,
                  beta.part.plot2, nrow = 2)
```


## Are changes random or deterministic for different treatments? 

At the highest studied elevation (Yawan) all treatment caused a shift from composition being deterministic in their divergence (predictably unpredictable to random). Similar shift, but weaker in cases of insecticide and fungicide was observed for Wanang. Strikingly different assembly was observed for Numba, where communities showed rather random assembly and only addition of herbivores increased divergence of the community composition.

```{r}

all.pairs_max_accuracy <- read.csv("data/raup_crick/all.pairs_max_accuracy.csv")
all.pairs_max_accuracy$fsite <- factor(all.pairs_max_accuracy$fsite, 
                                       levels = c("w","n","y"), labels = c("Wanang",
                                                                           "Numba",
                                                                           "Yawan"))

test.df <- data.frame()
for (st in unique(all.pairs_max_accuracy$fsite)){
  for (cp in unique(all.pairs_max_accuracy$comp)){
    
    print(paste(st, cp))
    
    subdat <- all.pairs_max_accuracy %>%
      filter(fsite == st & comp == cp)
    
    mod <- nlme::lme(RC ~ treatment,
                     random = ~1|comp.id,
                     data = subdat)

    # print(t.test(RC ~ treatment, data = subdat, paired = TRUE))
    
    test.df <- rbind(test.df, data.frame(fsite = st,
                                         comp = cp,
                                         group1 = tolower(substr(cp,1,1)),
                                         group2 = tolower(substr(cp,6,6)),
                                         test.res = summary(mod)$tTable[2,5]))
    
    # print(summary(mod))
    
  }
}

test.df <- test.df %>%
  mutate(label = ifelse(test.res < 0.05, "*"," "))

ggplot(all.pairs_max_accuracy, aes(x = treatment, y = RC))+
  # geom_boxplot()+
  ylim(c(-1.25,1.5))+
  stat_summary(fun.y = mean, na.rm = T,
               geom = "point", size = 4)+
  stat_summary(fun.data = "mean_cl_boot")+
  theme_bw()+
  ggtitle(paste("Accuracy = 0.001"))+
  geom_hline(yintercept = 0, lty = 2)+
  geom_hline(yintercept = 1, lty = 3)+
  geom_hline(yintercept = -1, lty = 3)+
  facet_grid(vars(fsite), vars(comp), scales = "free")+
  ggpubr::stat_pvalue_manual(data = test.df[test.df$label == "*",], label = "label",
                     y.position = 1.25, 
                     label.size = 6)

```

Making sense out of the above:

* Insects shape community composition at all elevations. Fungi affected community composition only in Yawan. Fungi increase the species richness, without affecting any other characteristics of the community (beta-diversity components). Whereas in Wanang despite having effect on richness and density the effects on the community composition was not visible possibly because of high baseline dissimilarity (variability in community composition) between sites. NUmba seems to be specific. Despite the effect being present they are being balanced in a way that left the community characteristics unchanged.

* Insect herbivores (P, I, H combined) can suppress plants in communities with low variability in species composition, which allows for new species to establish. Moreover, **insects reduce dissimilarity for highly variable communities** (is this true?). Exclusion of top predators has the same effect as insect exclusion on species turnover in Numba and Yawan. This is a probable result for a strong top-down control of the tri-trophic interactions. Addition of generalist herbivores also correlated with the predator effects. If the effects of insects are mainly caused by specialists, then generalists interfering with their feeding could have the same results. But the effects can be more subtle than those of herbivore removal.

### Traits and species faith

In this section we focus on plant species traits and how these can help us predict the performance of individual species at a given plot. First we attempt to predict simply whether a species, considering it's traits, will be lost, gained or will remain in various treatment plots. We used random forest to investigate the importance of traits in predicting the species faith. Prediction accuracy and classifier_RF will tell us how good well the set of traits is (and which traits are most important in predicting faith) for the faith of individuals.

First we analyze only traits ignoring location. Later we can mak an attempt to see wether importance of 

```{r}

source("code/pgls_data_prep.R")

subsetVars <- c("c", "i")

# 1. Prepare data ----
# Add richness
richdat <- data %>%
  group_by(site, garden, treatment) %>%
  summarise(richness = n()) %>%
  mutate(sgt = paste(site,garden,treatment, sep = "_"))

data.woody.brut <- data.woody.brut %>%
  mutate(sgt = paste(site,garden,treatment, sep = "_"))

dwbRich <- merge(data.woody.brut, richdat, by = "sgt")
  
# Filter and add estimated leaf area
dwbRichF <- dwbRich %>%
  mutate(est.leaf.area = num_leaf_weight * sla.w.m2kg1,
         lsla.d = log(sla.d.m2kg1),
         ltb = log(as.numeric(tot_bio)),
         labu = log(as.numeric(no_stems+1))) %>%
  dplyr::select(site.x, garden.x, treatment.x, 
         unified_names, tot_bio, no_stems, 
         perc.herb, water.cont, est.leaf.area, sla.d.m2kg1,
         richness, ltb, lsla.d, labu) %>%
  filter(water.cont > 0)

names(dwbRichF) <- c("site", "garden", "treatment", "unified_names","tot_bio",
                     "no_stems", "perc.herb", "water.cont", "est.leaf.area",
                     "sla.d.m2kg1", "richness", "ltb","lsla.d","labu")

# ENCLOSED IN THE get_ready_for_the_sla_analyses
# Subset a data-set to only control and treatment plots 
# subDat <- dwbRichF %>%
#   filter(treatment %in% subsetVars)
# 
# lgsData <- data.frame()
# 
# for (st in unique(subDat$site)){
#   for (gard in unique(subDat$garden)){
#     
#     stGardDat <- subDat %>%
#             filter(site == st,
#                    garden == gard)
#     
#     # Some quality control
#     if(dim(stGardDat)[1] == 0){
#       next
#       }
#     if(length(unique(stGardDat$treatment)) < 2){
#       next
#       }
#     
#     specInCtr <- unique(stGardDat[stGardDat$treatment == subsetVars[1], ]$unified_names)
#     specInTrt <- unique(stGardDat[stGardDat$treatment == subsetVars[2], ]$unified_names)
#     
#     spLost <- specInCtr[!(specInCtr %in% specInTrt)]
#     spGained <- specInTrt[!(specInTrt %in% specInCtr)]
#     
#     stGardDat$pg.cat <- ifelse(stGardDat$unified_names %in% spLost, "lost",
#                                ifelse(stGardDat$unified_names %in% spGained, "gained", "stayed"))
#     
#     
#     lgsData <- rbind(lgsData, stGardDat)
#     
#     
#   }
# }
```

I perform the sane analyses for each treatment.

```{r, results='asis'}
# Random Forest
# Loading package


rfAnalysis <- function(lgsData) {
  
  rfData <- lgsData %>%
  mutate(pg.cat = as.factor(pg.cat),
         lest.leaf.area = log(est.leaf.area),
         lstem = log(no_stems)) %>%
  dplyr::select(pg.cat, lstem, perc.herb, water.cont,
                lest.leaf.area, richness, ltb, lsla.d, treatment)
  # Try standardized, non-correlated variables
  rfDataRF <- rfData %>%
    filter(!is.infinite(lest.leaf.area)) %>%  
    dplyr::select(pg.cat, perc.herb, water.cont, richness, ltb, lsla.d)
  # Standardized
  rfDataRF[,-1] <- scale(rfDataRF[,-1])
  
  # Splitting data in train and test data
  split <- sample.split(rfDataRF, SplitRatio = 0.7)
  train <- subset(rfDataRF, split == "TRUE")
  test <- subset(rfDataRF, split == "FALSE")
  
  classifier_RF = randomForest(x = train[-1],
                               y = train$pg.cat,
                               ntree = 500)
  
  # Predicting the Test set results
  y_pred = predict(classifier_RF, newdata = test[-1])
  
  # Confusion Matrix
  confusion_mtx = table(test[, 1], y_pred)
  
  # Regression C50
  C50Fit <- C5.0(pg.cat ~., data=train,
                 control = C5.0Control(minCases = 5))
  C50pred <- predict(object=C50Fit, 
                     newdata=test, 
                     type="class")
  
  # return(list(rf_confusion_matrix = confusion_mtx,
  #             classifier_for_varImpPlot = varImpPlot(classifier_RF),
  #             reg_tree_table = table(C50pred, test$pg.cat),
  #             reg_fit_for_plot = plot(C50Fit, cex = 0.5)))
  
  return(list(rf_confusion_matrix = confusion_mtx,
              classifier_for_varImpPlot = classifier_RF,
              reg_tree_table = table(C50pred, test$pg.cat),
              reg_fit_for_plot = C50Fit))
  
  
  }

```

Using collected variables we cannot predict the faith of an individual species with high certainty. We can only predict which plants can be observed (stayed) at both control and insecticide treated plots. Error of that prediction is relatively low (0.16). For this prediction total biomass is the most important. SLA is least important, together with the number of stems. To visualize the division we run a single regression tree.

```{r, fig.width = 25, fig.height= 10}

# Run all random forests

subsetVars <- c("c", "p")
source('code/get_data_ready_for_the_sla_analyses.R')
prfres <- rfAnalysis(lgsData)

subsetVars <- c("c", "i")
source('code/get_data_ready_for_the_sla_analyses.R')
irfres <- rfAnalysis(lgsData)

subsetVars <- c("c", "f")
source('code/get_data_ready_for_the_sla_analyses.R')
frfres <- rfAnalysis(lgsData)

subsetVars <- c("c", "h")
source('code/get_data_ready_for_the_sla_analyses.R')
hrfres <- rfAnalysis(lgsData)

```

The above tree is just a one example of hundreds of averaged trees used in the random forest. A few key conclusions can be drawn from the above analyses is that we cannot in certain predict the faith of a tree species. But its biomass is the best predictor together with water content. SLA seems to be the least important.

Let us now move to test SLA ability to predict the biomass of an individual. This is a bit tricky because we will use SLA estimated at the end of the experiment. From the leaf frame analyses that spanned all plant species in all treatment plots we saw high plasticity of that trait.

```{r, figures-side, fig.show="hold", out.width="50%"}
varImpPlot(prfres$classifier_for_varImpPlot,
           main = 'Variable Importance for the predator exclusion')
varImpPlot(irfres$classifier_for_varImpPlot,
           main = 'Variable Importance for the insect exclusion')
varImpPlot(frfres$classifier_for_varImpPlot,
           main = 'Variable Importance for the fungi exclusion')
varImpPlot(hrfres$classifier_for_varImpPlot,
           main = 'Variable Importance for the herbivore addition')
```

## Trait-based predictions of a species success

### At the level of the whole community

Community-weighted mean SLA (CWM SLA) was higher at low diversity plots. This means that species with RELATIVELY higher SLA were the ones that dominated the communities. In Numba baseline SLA was reduced even further. In Numba also fungicide treatment had lower baseline SLA. 

In both cases slope of the relationship was increased (less steep, it was flatter, no relationship).

```{r, fig.cap='Community weighted mean vs number of species at a site for the studied treatments at three elevations. Size of a point indicates total plant biomass of that plot.'}

# SLA values of individual plant species for each treatment.

# I am using the data.woody.brut data-set from the pgls_data_prep script. It has
# filtered woody palnt names, cleaned sla.d values and limited sla range.

# Define CWM function
cwmFun <- function(sla.d.m2kg1, tot_bio){
  # summarize function: CWM for sites
  return(mean(sla.d.m2kg1*(tot_bio/sum(tot_bio, na.rm = T)), na.rm = T))
}

# siteSLA <- data.woody.brut %>%
#   filter(unified_names %in% trait.dat[trait.dat$Life.form == "woody", ]$dsName) %>%
#   mutate(tot_bio = ifelse(is.infinite(tot_bio), NA, tot_bio),
#          sla.d.m2kg1 = ifelse(is.infinite(sla.d.m2kg1), NA, sla.d.m2kg1)) %>%
#   group_by(site, garden, treatment) %>%
#   summarise(cwm.sla = cwmFun(sla.d.m2kg1, n.tot_bio),
#             sp.rich = n())

siteSLA <- data.woody.brut %>%
  filter(treatment %in% c('i','c','p','h', 'f')) %>%
  mutate(tot_bio = ifelse(is.infinite(tot_bio), NA, tot_bio),
         sla.d.m2kg1 = ifelse(is.infinite(sla.d.m2kg1), NA, sla.d.m2kg1)) %>%
  group_by(site, garden, treatment) %>%
  summarise(cwm.sla = cwmFun(sla.d.m2kg1, n.tot_bio),
            sp.rich = n(),
            total.bio = sum(n.tot_bio))

siteSLAdf <- as.data.frame(siteSLA)

rownames(siteSLAdf) <- paste(substr(siteSLA$site,1,1), 
                             siteSLA$garden, 
                             "_", 
                             siteSLA$treatment, sep = "")

# Plot of CWM vs species richness
require(scales)
p1 <- ggplot(siteSLAdf, aes(x = sp.rich, y = cwm.sla))+
  geom_point(aes(size = total.bio, color = treatment)) + 
  stat_smooth(method = "lm")+
  scale_x_continuous(trans = 'log2',
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +
  scale_y_continuous(trans = 'log2',
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +  theme_minimal()

p2 <- ggplot(siteSLAdf, aes(x = treatment, y = cwm.sla, fill = site))+
  geom_boxplot()+
  scale_y_continuous(trans = 'log2',
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +  theme_minimal()

p3 <- ggplot(siteSLAdf, aes(x = site, y = cwm.sla, fill = treatment))+
  geom_boxplot()+
  scale_y_continuous(trans = 'log2',
    breaks = trans_breaks("log2", function(x) 2^x),
    labels = trans_format("log2", math_format(2^.x))) +  theme_minimal()

ggpubr::ggarrange(p1,p2, p3)

# What is that value for the Y, g8, p?
# This seem to be an outlier - very low total biomass
# data.woody.brut %>% filter(site == 'yawan',
#                            garden == 'g8',
#                            treatment == 'p')

```

```{r, results='asis'}
# Test for the relationship and the differences
require(sjPlot)
cwm.lm <- lm(log(cwm.sla)~log(sp.rich)*treatment + site, data = siteSLAdf)
cwm.lm.nosite <- lm(log(cwm.sla)~log(sp.rich)*treatment, data = siteSLAdf)
cwm.lm.nosite.noint <- lm(log(cwm.sla)~log(sp.rich)+treatment, data = siteSLAdf)
cwm.lm.onlysp <- lm(log(cwm.sla)~log(sp.rich), data = siteSLAdf)


# cwm.glm <- glm(cwm.sla~sp.rich*treatment + site, data = siteSLAdf,
#              family = gaussian(link = 'log'))
# cwm.glm.nosite <- glm(cwm.sla~sp.rich*treatment, data = siteSLAdf,
#                     family = gaussian(link = 'log'))
# cwm.glm.nosite.noint <- glm(cwm.sla~sp.rich+treatment, data = siteSLAdf, 
#                           family = gaussian(link = 'log'))
# cwm.glm.onlysp <- glm(cwm.sla~sp.rich, data = siteSLAdf, family = gaussian(link = 'log'))

# tab_model(cwm.lm.nosite.noint)


# anova(cwm.lm.nosite, cwm.lm.onlysp)
knitr::kable(AIC(cwm.lm, cwm.lm.nosite, cwm.lm.nosite.noint, cwm.lm.onlysp))
# knitr::kable(AIC(cwm.glm, cwm.glm.nosite, cwm.glm.nosite.noint, cwm.glm.onlysp,
                 # cwm.lm, cwm.lm.nosite, cwm.lm.nosite.noint, cwm.lm.onlysp))

# tab_model(cwm.glm)
tab_model(cwm.lm.onlysp)

# plot(cwm.glm)
# plot(cwm.lm)

# there are no differences 

```

The CWM and species number relation is strong and does not change between the treatments and sites. 

### Individual species performance

Our original idea was that SLA (approximation of a growth rate) should become a better predictor of plant success (fitness, measured as total biomass in a plot, or positive change in biomass - deltaBio) with elevation.

## SLA

### Can traits predict change in composition?
SLA doesnâ€™t predict RDA position along C->I, C->H, C->P, C -> F axes, at any elevation.
Community composition change under a treatment may be independent of SLA. [key indicator of functionally important aspects of photosynthetic capacity, and is positively correlated with ecosystem productivity (White et al., 2000, Madani et al., 2017, Anderson et al., 2020). Reflects the abilities of light capture and adaption to environments of plants (Gao, Wang, and Zhang 2022)]

```{r}
# Calculate position of species and site along a given treatment vector.
function (oridnation, treatment, type = c('site','species')) {
  NULL
}

surfData <- data.woody.brut %>%
  filter(site == "wanang") %>%
  group_by(unified_names) %>%
  summarise(lsla.d = log(mean(sla.d, na.rm=T)),
            water.cont = mean(water.cont, na.rm = T),
            herbivory = mean(perc.herb, na.rm = T))

# Add row names to sla data
surfDataDf <- as.data.frame(surfData)
tibble::column_to_rownames(surfData, var = 'unified_names')
rownames(surfDataDf) <- surfDataDf$unified_names

# Get the treatment vector.
nm <- "f"
# names(ord.list[["w"]])
trtVcts <- ord.list[["w"]]$CCA$biplot[nm, c(1,2)]

# Get species vector.
all.specs <- ord.list[["w"]]$CCA$v[, c(1,2)]
usednms <- surfData$unified_names[surfData$unified_names %in% rownames(all.specs)]
specVcts <- all.specs[usednms,]

# Projection of species onto treatment vector.
VdotU <- ((specVcts %*% trtVcts))
uNormSq <- (trtVcts %*% trtVcts)
projUV <- (VdotU/as.numeric(uNormSq)) %*% t(as.matrix(trtVcts))

# Get norm for each projection vector.
positions <- apply(projUV, 1, function(x) sqrt(x %*% x))

# Add positions to the data frame.
modDat <- data.frame(value = c(surfDataDf[usednms, ]$lsla.d,
                               surfDataDf[usednms, ]$water.cont,
                               surfDataDf[usednms, ]$herbivory),
                     label = rep(c("SLA", "Water Content", "Herbivory"), 
                                 each = length(positions)),
                     pos = positions[usednms])

testDat <- data.frame(sla = surfDataDf[usednms, ]$lsla.d,
                      water = surfDataDf[usednms, ]$water.cont,
                      herb = surfDataDf[usednms, ]$herbivory,
                      pos = positions[usednms])

ggplot(modDat, aes(x = pos, y = value)) +
  geom_point()+
  stat_smooth(method = "lm") + 
  facet_wrap(~label, scales = 'free')

# Tests + phylogeny!!!!
glsmod1 <- gls(pos ~ sla + water + herb, data = testDat)
glsmod2 <- gls(pos ~ sla +       + herb, data = testDat)
glsmod3 <- gls(pos ~ sla + water       , data = testDat)
glsmod4 <- gls(pos ~               herb, data = testDat)
glsmod5 <- gls(pos ~       water       , data = testDat)
glsmod6 <- gls(pos ~ sla               , data = testDat)

summary(glsmod1)
summary(glsmod2)
summary(glsmod3)
summary(glsmod4)
summary(glsmod5)
summary(glsmod6)

AIC(glsmod1,glsmod2,glsmod3,glsmod4,glsmod5,glsmod6)

summary(glsmod1)

myTree


# Correlate positions with individual species' with their sla. CWM we can leave out because we know it correlates with the .

```

### Can SLA predict 'success' of a plant species?

In control plots with increasing elevation we hypothesize that SLA (used here as a proxy for the growth rate) should predict species' success (fitness, dominance, change in biomass in response to the treatment) better at higher elevation. Specifically, we expect that plants with higher SLA should be characterized by greater ability to dominate the community (higher total biomass - or should it be relative biomass? Or should it be biomass change?) in treatments where natural enemies were removed. We assume that in these cases inter-specific plant competition should be driven mainly by growth rates.

However there are a few contingent effects that make interpretation of this relationship problematic:

1. SLA of a species may be *determined by the community in which it resides*. CWM and richness dependency points to that. However, at the *individual level we do not see that species generally change their SLA in response to richness of the plot* on which they reside. This suggests that increased CWM SLA at low richness plots is driven by dominance of high SLA plants rather than changes in SLA by the same dominants, as would be suggested by the lack of differences in the community composition. This lack of significant effect of treatments in the RDA analysis may in turn be caused by a large variation between gardens (high variability in the control sites). 

```{r}

# SLA of selected species at different treatments.

# Sla of selected species vs species richness

```

2. From our data we see that at some treatments same species may have different average SLA

3. Change in biomass (delta biomass) may be a better measurement of a species' response to a treatment. This excludes also species that were lost or gained as a response to a treatment. However, it was shown in the previous analysis that these plants were rather small and either in poor condition or just got established at a plot.

4. Change in biomass may be correlated to change in SLA (LRR like plots: what are the results of this?)

```{r}

# Change in SLA vs change in Biomass

```

5. Biomass/$\Delta$Biomass may be smaller if there are many individuals of the same species around. Therefore I think we should **include also the effect of the co-specificsâ€™ abundance**.

6. Additionally total biomass may influence the biomass change, i.e, change in biomass may be smaller for smaller plants and larger for larger plants. What does this measure mean? Delta BIO measures how dominance has changed. If there was a dominant plant in the control and its biomass decreased a lot in the treatment what that would mean?

Taking the above considerations into account we formulated the final statistical model. The response variable was the $\Delta$Biomass. We tested whether it is dependent on SLA but also include the corresponding *site richness* and the *abundance of co-specifics* as co-variate. To test treatment influence on $\Delta$Biomass vs SLA relationship we included the interaction between SLA and treatment variable. We repeated model for each site and evaluated the model performance to compare power of SLA to predict the biomass changes at each elevation. We added a quadratic term for the Phylogenetic correlations are preserved:

Below I explore nonlinear relationships of the biomass log-ratios with species traits. Nonlinear relationships are introduced to allow for optimum trait values.

It seems that in some cases the nonlinear relationship may be important. Generally water content looks linear for each elevation. We will include this and build also a model that models log-ratio biomass vs water content as a linear relationship. We arrive to the final definition of the full model.

$\Delta$Biomass ~ SLA $\times$ site + SLA^2 $\times$ site + 
water.content $\times$ site + water.content^2 $\times$ site + 
perc.herb $\times$ site  + perc.herb^2 $\times$ site + 
richness + abundance + $\Delta$SLA + 
(Phylogenetic structure). 

#### Insecticide 

```{r}

# Get the delta data ready for th e given subset vars (comparison)
subsetVars <- c("c", "i")
source('code/get_data_ready_for_the_sla_analyses.R')

# ggpubr::ggarrange(slaPlot, wcPlot, herbPlot)

```

```{r, results='asis'}

source('code/model_definitions_pgls.R')

# Are traits improving the null model

# Model selection.

# 1. Full model (quadratic, and site interactions) vs no traits
# anova(no.traits, full.model)            # full model is better


# 2. Removal of individual traits

# 2.1 Remove SLA
# anova(full.model, q.herb.q.water) # no-difference, keep model without the SLA a simpler model?
# 2.2 Remove herbivory
# anova(full.model, q.sla.q.water.noint) # Model without herbivory is significantly worse
# 2.3 Remove water content?
# anova(full.model, q.sla.q.herb) # Model without water is significantly worse

# Herbivory and water are the most important!!!

# 3. Reduce model even further - 1 trait models.
# anova(q.herb.q.water, just.sla.quadratic)   # Two trait model better
# anova(q.herb.q.water, just.herb.quadratic)  # Two trait model better
# anova(q.herb.q.water, just.water.quadratic) # Two trait model better

# 4. Quadratic vs linear
# anova(q.herb.q.water, l.herb.l.water) # Quadratic model is still better

# 5. Interaction reduction
# anova(q.herb.q.water, q.herb.q.water.noint) # Model with interaction is better
# anova(q.herb.q.water, just.water.quadratic.noint) # Model with interaction is better
# anova(q.herb.q.water, just.water.linear.noint)

```

```{r, results='asis'}
# So the best model is the one without the traits!
# tab_model(q.herb.q.water)
# tab_model(just.water.quadratic.noint)
i.mod <- q.herb.q.water
i.dD <- deltaData
```

Nevertheless it is not a strong correlation and does not explain a lot of variation in the biomass change.

In general there is some evidence for the change in total biomass to be driven by the sla. Water content and log-response ratios of SLA are significantly affecting the change in total biomass. The change however might be determined by a strong correlation at one site only: Wanang. Higher water content results in positive change in biomass of a species, while if we have large increase in SLA of a species that was correlated with reduction of a species' biomass. **None of the interactions with site were significant.**

Random effect is not necessary because we have paired comparisons of control vs treatment within the same garden. **Another option** is to include site as a random factor and get rid of all the interaction terms.

This model needs to be applied separately for each treatment comparison.

First we analyse the focused model, where we use only SLA as a predictor of species' success. Further we compare the models' performance between sites to explore the idea that SLA is an increasingly better predictor of a species responses with elevations.

The model above has the interactive effect of site, but later I perform analyses at each site separately. **Which approach should I choose?**

However, when we analyse the data separately for each elevation we are getting a different results **if we only use the lsla.d variable**. The more realistic models could change this relationship, i.e., when we include also the effects of species richness and other traits as we did above.

#### Fungicide

```{r}

subsetVars <- c("c", "f")

source('code/get_data_ready_for_the_sla_analyses.R')

# ggpubr::ggarrange(slaPlot, wcPlot, herbPlot)

```

```{r, results='asis'}

source('code/model_definitions_pgls.R')

# Are traits improving the null model

# Model selection.

# 1. Full model (quadratic, and site interactions) vs no traits
# anova(no.traits, full.model)            # full model is better


# 2. Removal of individual traits

# 2.1 Remove SLA
# anova(full.model, q.herb.q.water) # without sla is slightly better (AIC)

# 2.2 Remove herbivory
# anova(full.model, q.sla.q.water) # Model without herbivory is not better

# Both q.herb.q.water and q.sla.q.water are simpler, but which one is better?
# anova(full.model, q.sla.q.herb) # Model without water is significantly worse

# 2.3 Remove water content?
# anova(full.model, q.sla.q.herb) # Model with herbivory is much better!
# Water is important!!!

# anova(q.herb.q.water, q.sla.q.water) # q.sla.q.water is better based on AIC


# 3. Reduce model even further - 1 trait models.
# anova(q.sla.q.water, just.sla.quadratic)  # q.sla.q.water is still better
# anova(q.sla.q.water, just.herb.quadratic) # q.sla.q.water is still better
# anova(q.sla.q.water, just.water.quadratic) # model with just water is as good as q.sla.q.water

# model with just water is not different form the full model, and it has lower AIC

# Seems like they all stay!

# 4. Quadratic vs linear
# anova(just.water.quadratic, just.water.linear) # Linear is simpler model still better

# 5. Interaction reduction
# anova(just.water.linear, just.water.linear.noint) # Interaction does not bring anything to the model

```


```{r, results='asis'}

# So the best model is the one with only water!
# tab_model(just.water.linear.noint)
f.mod <- just.water.linear.noint
f.dD <- deltaData
```

#### Additional herbivores

```{r}
subsetVars <- c("c", "h")

source('code/get_data_ready_for_the_sla_analyses.R')

# ggpubr::ggarrange(slaPlot, wcPlot, herbPlot)


```

```{r, results='asis'}

source('code/model_definitions_pgls.R')

# Are traits improving the null model

# Model selection.

# 1. Full model (quadratic, and site interactions) vs no traits
# anova(no.traits, full.model)            # full model is better


# 2. Removal of individual traits

# 2.1 Remove SLA
# anova(full.model, q.herb.q.water) # without sla is slightly better (AIC)

# 2.2 Remove herbivory
# anova(full.model, q.sla.q.water) # Model without herbivory is not better

# 2.3 Remove water content?
# anova(full.model, q.sla.q.herb) # Model with herbivory is much better

# Two candidate models:
# anova(q.herb.q.water,q.sla.q.water) # q.sla.q.water is a bit better (AIC)

# 3. Reduce model even further - 1 trait models.
# anova(q.sla.q.water, just.sla.quadratic) # MOdel with water is significantly better than just sla
# anova(q.sla.q.water, just.herb.quadratic) # It is better than just herbivory
# anova(q.sla.q.water, just.water.quadratic) # But is not better than model with just water

# Seems like they all stay!

# 4. Quadratic vs linear
# anova(just.water.quadratic, just.water.linear) # Linear model is not simpler, it has slightly higher AIC

# 5. Interaction reduction
# anova(just.water.linear, just.water.linear.noint) # Interaction model is significantly better
```

```{r, results='asis'}
# So the best model is ... !
# tab_model(just.water.linear)
h.mod <- just.water.linear
h.dD <- deltaData
```

#### Predators

```{r}
subsetVars <- c("c", "p")

source('code/get_data_ready_for_the_sla_analyses.R')

# ggpubr::ggarrange(slaPlot, wcPlot, herbPlot)


```

```{r, results='asis'}

source('code/model_definitions_pgls.R')

# Are traits improving the null model

# Model selection.

# 1. Full model (quadratic, and site interactions) vs no traits
# anova(no.traits, full.model)            # full model is better


# 2. Removal of individual traits

# 2.1 Remove SLA
# anova(full.model, q.herb.q.water) # Full model is significanlty better

# 2.2 Remove herbivory
# anova(full.model, q.sla.q.water.noint) # Full model still better

# 2.3 Remove water content?
# anova(full.model, q.sla.q.herb) # Full model still better

# 3. Reduce model even further - 1 trait models.
# anova(full.model, just.sla.quadratic)
# anova(full.model, just.herb.quadratic)
# anova(full.model, just.water.quadratic)

# Seems like they all stay!

# 4. Quadratic vs linear
# anova(full.model, all.linear) # Full model still better

# 5. Interaction reduction
# anova(full.model, full.model.noint) # Full model still better
```

```{r, results='asis'}
# So the best model is the one without the traits!
# tab_model(full.model)
p.mod <- full.model
p.dD <- deltaData
```

### SLA models for treatments

```{r, results='asis'}

tab_model(p.mod, i.mod, h.mod, f.mod,
          pred.labels = c("Intercept", 
                          "Log[SLA]-linear", 
                          "Numba", 
                          "Yawan",
                          "Log[SLA]-quadratic", 
                          "Water content - linear", 
                          "Water content - quadratic",
                          "Herbivory [%] - linear",
                          "Herbivory [%] - quadratic",
                          "Species richness",
                          "Abundance",
                          "LRR SLA",
                          "Log[SLA]-linear : Numba",
                          "Log[SLA]-linear : Yawan",
                          "Log[SLA]-quadratic : Numba",
                          "Log[SLA]-quadratic : Yawan",
                          "Water content-linear : Numba",
                          "Water content-linear : Yawan",
                          "Water content-quadratic : Numba",
                          "Water content-quadratic : Yawan",
                          "Herbivory-linear : Numba",
                          "Herbivory-linear : Yawan",
                          "Herbivory-quadratic : Numba",
                          "Herbivory-quadratic : Yawan"),
          dv.labels = c("Predator", "Insecticide", "Extra herbivory", "Fungicide"),
          string.pred = "Coeffcient",
          string.ci = "Conf. Int (95%)",
          string.p = "P-Value")

```

### Predictions and visualizations

```{r}
source("code/predictAndVisualize_function.R")

# Predator --------------------------
pslap <- predictAndVisualize(p.mod, 
                    p.dD,
                    "lsla.d",
                    n = 100,
                    titlestring = "Predator - Specific Leaf Area",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Log(SLA)")


# Focal traits

# Co-variates
psitep <- predictAndVisualize(p.mod, 
                    p.dD,
                    "fsite",
                    n = 100,
                    titlestring = "Predator - Site",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Sites")

plabup <- predictAndVisualize(p.mod, 
                    p.dD,
                    "labu",
                    n = 100,
                    titlestring = "Predator - Abundance",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Log(stem number)")
prichp <- predictAndVisualize(p.mod, 
                    p.dD,
                    "richness",
                    n = 100,
                    titlestring = "Predator - Richness",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Number od species")
plrrslap <- predictAndVisualize(p.mod, 
                    p.dD,
                    "lrrsla",
                    n = 100,
                    titlestring = "Predator - LRR SLA",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "LRR SLA")


# Insecticide-----------------------
ilabup <- predictAndVisualize(i.mod, 
                    i.dD,
                    "labu",
                    n = 100,
                    titlestring = "Insecticide - Abundance",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Log(stem number)")



# Extra herbivory-------------------
hsitep <- predictAndVisualize(h.mod, 
                    h.dD,
                    "fsite",
                    n = 100,
                    titlestring = "Herbivory - Site",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Sites")

hwaterp <- predictAndVisualize(h.mod, 
                    h.dD,
                    "water.cont",
                    n = 100,
                    titlestring = "Herbivory - Water Content",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Water content")


hlabup <- predictAndVisualize(h.mod, 
                    h.dD,
                    "labu",
                    n = 100,
                    titlestring = "Herbivory - Abundance",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Log(stem number)")

hlrrslap <- predictAndVisualize(h.mod, 
                    h.dD,
                    "lrrsla",
                    n = 100,
                    titlestring = "Herbivory - LRR SLA",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "LRR SLA")

# Fungicide

fwaterp <- predictAndVisualize(f.mod, 
                    f.dD,
                    "water.cont",
                    n = 100,
                    titlestring = "Fungicide - Water Content",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Water content")

fsitep <- predictAndVisualize(f.mod, 
                    f.dD,
                    "fsite",
                    n = 100,
                    titlestring = "Fungicide - Site",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Site")

frichp <- predictAndVisualize(f.mod, 
                    f.dD,
                    "richness",
                    n = 100,
                    titlestring = "Fungicide - Richness",
                    ylabstring = "Log-response ratio of total biomass.",
                    xlabstring = "Number of species per plot")

# Plot
ggpubr::ggarrange(pslap +
                    scale_y_continuous(limits = c(-5, 10)),
                  fwaterp + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  hwaterp + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  nrow = 1, legend = F)
ggpubr::ggarrange(psitep + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  fsitep + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  hsitep + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  nrow = 1,legend = F)
ggpubr::ggarrange(prichp + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  frichp + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  nrow = 1, legend = F)
ggpubr::ggarrange(plabup + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  ilabup + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  hlabup + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  nrow = 1, legend = F)
ggpubr::ggarrange(plrrslap +
                    scale_y_continuous(limits = c(-5, 10)), 
                  hlrrslap + 
                    scale_y_continuous(limits = c(-5, 10)), 
                  nrow = 1, common.legend = T)

```


```{r}
# Insecticide


```

